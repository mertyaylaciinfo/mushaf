<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Üç Aylar Rehberi</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
            height: 100vh; 
            height: -webkit-fill-available;
            overflow: hidden;
        }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .pb-safe { padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 60px) !important; } 
        .pt-safe { padding-top: env(safe-area-inset-top, 20px); }
        
        .tab-content { display: none; height: 100%; flex-direction: column; }
        .tab-content.active { display: flex; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* TESBİH */
        .tesbih-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; display: flex; justify-content: center; background: radial-gradient(circle at center, #f8fafc 0%, #e2e8f0 100%); touch-action: none; }
        .tesbih-string { position: absolute; top: -200px; bottom: -200px; width: 4px; background: #9ca3af; box-shadow: inset 1px 1px 2px rgba(0,0,0,0.3); z-index: 0; left: 50%; transform: translateX(-50%); }
        .bead-wrapper { position: absolute; left: 50%; top: 22%; transform: translateX(-50%); width: 100px; height: 550px; }
        .bead { width: 70px; height: 60px; border-radius: 45%; position: absolute; left: 50%; margin-left: -35px; z-index: 10; background: radial-gradient(circle at 35% 35%, #f59e0b, #b45309); box-shadow: inset -3px -3px 10px rgba(0,0,0,0.4), inset 3px 3px 10px rgba(255,255,255,0.4), 0 5px 10px rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: center; transition: transform 0.1s linear; pointer-events: none; }
        .bead::after { content: ''; width: 10px; height: 5px; background: #451a03; border-radius: 50%; opacity: 0.7; box-shadow: inset 0 1px 2px rgba(0,0,0,0.8); }
        .bead.active { z-index: 20; }
        .page-badge { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
        
        /* Buton Stilleri */
        .tool-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 9999px; background-color: #ecfdf5; color: #059669; border: 1px solid #d1fae5; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; flex-shrink: 0; }
        .tool-btn:hover { background-color: #d1fae5; color: #047857; transform: scale(1.05); }
        .tool-btn:active { transform: scale(0.95); }
        .tool-btn i { font-size: 1rem; }
        
        .speed-btn { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: white; color: #059669; border: 1px solid #10b981; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: all 0.1s; }
        .speed-btn:active { transform: scale(0.9); background-color: #ecfdf5; }

        /* Arama */
        #search-suggestions { position: absolute; top: 100%; left: 0; right: 0; background-color: white; border: 1px solid #e5e7eb; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-bottom-left-radius: 0.75rem; border-bottom-right-radius: 0.75rem; z-index: 50; max-height: 15rem; overflow-y: auto; display: none; }
        #search-suggestions:not(.hidden) { display: block; }
        .suggestion-item { padding: 0.75rem 1rem; font-size: 0.875rem; color: #374151; border-bottom: 1px solid #f9fafb; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .suggestion-item:hover { background-color: #ecfdf5; }
        .suggestion-item:last-child { border-bottom: none; }
        
        .hidden-force { display: none !important; }
        .flex-force { display: flex !important; }

        /* Namaz Vakitleri Kartı */
        .prayer-time-item { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 6px; border-radius: 8px; min-width: 55px; }
        .prayer-time-item.active { background-color: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); font-weight: bold; transform: scale(1.05); }
        .prayer-checkbox { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .prayer-checkbox.completed { background-color: #d1fae5; border-color: #10b981; color: #065f46; }
        
        /* --- OKUMA MODU STİLLERİ --- */
        body.reading-mode header,
        body.reading-mode #main-nav,
        body.reading-mode .sticky, 
        body.reading-mode #quran-display { display: none !important; }
        
        body.reading-mode .w-full.max-w-md {
            max-width: 100% !important; width: 100% !important; height: 100% !important;
            border-radius: 0 !important; margin: 0 !important; box-shadow: none !important;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999;
        }
        
        body.reading-mode #tab-quran { height: 100% !important; width: 100% !important; display: flex !important; padding: 0 !important; margin: 0 !important; }
        #reading-mode-layout { display: none; width: 100%; height: 100%; flex-direction: row; background-color: #fffdf5; position: relative; }
        body.reading-mode #reading-mode-layout { display: flex !important; }

        #reading-display { flex: 1; height: 100%; overflow-y: auto; position: relative; background-color: #fffdf5; touch-action: pan-y; scrollbar-width: none; -ms-overflow-style: none; display: flex; flex-direction: column; }
        #reading-display::-webkit-scrollbar { display: none; }

        .reading-sidebar { width: 70px; background-color: #f9fafb; border-left: 1px solid #e5e7eb; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1.5rem; padding: 10px; z-index: 100; flex-shrink: 0; height: 100%; }
        .reading-mode-toggle-btn { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: #10b981; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s; border: none; cursor: pointer; }
        .reading-mode-toggle-btn:active { transform: scale(0.95); }
        .reading-mode-toggle-btn.active { background-color: #10b981; }
        .reading-info-box { text-align: center; margin-bottom: auto; margin-top: 20px; width: 100%; }
        .reading-info-item { display: block; font-size: 0.7rem; color: #4b5563; margin-bottom: 5px; background: #ffffff; padding: 6px 4px; border-radius: 6px; border: 1px solid #e5e7eb; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        body.reading-mode #quran-page-image { width: auto !important; height: auto !important; max-width: 100% !important; object-fit: contain; display: block; margin: auto; }
        
        #main-nav { position: absolute; bottom: 0; width: 100%; z-index: 40; border-top: 1px solid rgba(255,255,255,0.2); padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 60px); padding-top: 10px; height: auto; min-height: 5rem; }
        
        .goal-reached { color: #059669 !important; transform: scale(1.1); text-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }
        
        .debt-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s; }
        .debt-btn:active { transform: scale(0.9); }

        /* Accordion Styles */
        .accordion-content {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        }
        .accordion-content.open {
            opacity: 1;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }

        /* HEADER ANIMATION STYLES */
        #dynamic-header {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            box-shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.2);
        }
        /* Collapsed State Styles */
        body.header-shrunk #dynamic-header {
            padding-bottom: 0.5rem;
            padding-top: max(env(safe-area-inset-top, 20px), 10px);
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
        }
        
        #header-expanded-content {
            transition: opacity 0.3s ease-out, max-height 0.4s ease-out, transform 0.4s ease-out;
            max-height: 500px;
            opacity: 1;
            transform: translateY(0);
        }
        
        body.header-shrunk #header-expanded-content {
            max-height: 0;
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
            margin: 0;
            padding: 0;
        }

        #header-collapsed-content {
            max-height: 0;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.4s ease-out;
        }

        body.header-shrunk #header-collapsed-content {
            max-height: 50px;
            opacity: 1;
            transform: translateY(0);
            display: flex;
        }

        /* Title Area Transition */
        #header-top-bar {
            transition: all 0.3s ease;
        }
        body.header-shrunk #header-top-bar {
            display: none; 
        }

        /* --- KANDİL EFEKTLERİ --- */
        .kandil-wrapper {
            position: absolute;
            top: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            overflow: hidden;
        }
        
        .kandil {
            position: absolute;
            top: -20px; 
            transform-origin: top center;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3));
        }

        .kandil-left { left: 8%; width: 45px; }
        .kandil-right { right: 8%; width: 45px; }
        .kandil-center { left: 50%; transform: translateX(-50%); width: 60px; top: -25px; }

        .kandil-flame {
            transform-origin: center bottom;
            animation: flame-pulse 3s ease-in-out infinite alternate;
        }
        
        .kandil-glow {
            transform-origin: center center;
            animation: glow-pulse 3s ease-in-out infinite alternate;
        }

        @keyframes flame-pulse {
            0% { transform: scale(0.9); opacity: 0.7; }
            50% { transform: scale(1.05); opacity: 0.95; }
            100% { transform: scale(0.95); opacity: 0.8; }
        }
        
        @keyframes glow-pulse {
            0% { transform: scale(0.8); opacity: 0.3; }
            100% { transform: scale(1.2); opacity: 0.6; }
        }

        .arabesque-pattern {
            background-color: transparent;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20 20.12l-6.23-6.23a4.5 4.5 0 0 0-6.36 0 4.5 4.5 0 0 0 0 6.36L13.77 26.6l6.23 6.23 6.23-6.23 6.36-6.36a4.5 4.5 0 0 0 0-6.36 4.5 4.5 0 0 0-6.36 0L20 20.12zM20 0c11.046 0 20 8.954 20 20s-8.954 20-20 20S0 31.046 0 20 8.954 0 20 0zm0 2a18 18 0 1 0 0 36 18 18 0 0 0 0-36z' fill='%23ffffff' fill-opacity='0.07' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        
        /* Auth Overlay Styles */
        #auth-overlay {
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex justify-center overflow-hidden bg-gray-100">

    <div id="main-container" class="w-full max-w-md h-full bg-white shadow-2xl relative flex flex-col overflow-hidden sm:rounded-xl sm:h-[95vh] sm:my-auto transition-all duration-300">
        
        <!-- DYNAMIC HEADER -->
        <header id="dynamic-header" class="bg-gradient-to-br from-emerald-800 to-teal-900 text-white shadow-md z-20 shrink-0 pt-safe relative">
            <!-- Arka Plan Deseni -->
            <div class="absolute inset-0 arabesque-pattern opacity-30 pointer-events-none"></div>
            
            <!-- Kandiller -->
            <div class="kandil-wrapper">
                <!-- Sol Kandil -->
                <div class="kandil kandil-left">
                    <svg viewBox="0 0 100 400" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <line x1="50" y1="0" x2="50" y2="150" stroke="#fcd34d" stroke-width="2"/>
                        <circle cx="50" cy="150" r="3" fill="#fcd34d"/>
                        <path d="M25 160 Q15 210 50 240 Q85 210 75 160 H25 Z" fill="rgba(255,255,255,0.15)" stroke="#fcd34d" stroke-width="2"/>
                        <path d="M48 200 Q50 180 52 200" stroke="#fcd34d" stroke-width="2"/>
                        <circle cx="50" cy="210" r="15" fill="#fbbf24" filter="blur(8px)" class="kandil-glow"/>
                        <path d="M50 220 Q40 200 50 185 Q60 200 50 220" fill="#fbbf24" class="kandil-flame"/>
                    </svg>
                </div>
                <!-- Orta Kandil (Büyük) -->
                <div class="kandil kandil-center">
                    <svg viewBox="0 0 100 400" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <line x1="50" y1="0" x2="50" y2="180" stroke="#fcd34d" stroke-width="3"/>
                        <circle cx="50" cy="180" r="4" fill="#fcd34d"/>
                        <path d="M20 190 Q10 250 50 290 Q90 250 80 190 H20 Z" fill="rgba(255,255,255,0.2)" stroke="#fcd34d" stroke-width="3"/>
                        <circle cx="50" cy="250" r="20" fill="#f59e0b" filter="blur(12px)" class="kandil-glow"/>
                        <path d="M50 265 Q35 235 50 215 Q65 235 50 265" fill="#fbbf24" class="kandil-flame"/>
                    </svg>
                </div>
                <!-- Sağ Kandil -->
                <div class="kandil kandil-right">
                     <svg viewBox="0 0 100 400" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <line x1="50" y1="0" x2="50" y2="150" stroke="#fcd34d" stroke-width="2"/>
                        <circle cx="50" cy="150" r="3" fill="#fcd34d"/>
                        <path d="M25 160 Q15 210 50 240 Q85 210 75 160 H25 Z" fill="rgba(255,255,255,0.15)" stroke="#fcd34d" stroke-width="2"/>
                        <circle cx="50" cy="210" r="15" fill="#fbbf24" filter="blur(8px)" class="kandil-glow"/>
                        <path d="M50 220 Q40 200 50 185 Q60 200 50 220" fill="#fbbf24" class="kandil-flame"/>
                    </svg>
                </div>
            </div>

            <div class="p-3 relative z-10">
                <!-- 1. Top Bar (Title & Date) -->
                <div id="header-top-bar" class="flex justify-between items-center mb-2 mt-8">
                    <div>
                        <h1 class="text-xl font-bold tracking-tight flex items-center gap-2 drop-shadow-md">
                            <i class="fas fa-moon text-yellow-300"></i> <span style="font-family: 'Amiri', serif;">Üç Aylar Rehberi</span>
                        </h1>
                        <p class="text-xs text-emerald-100 opacity-90 font-medium" id="current-date">Yükleniyor...</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <!-- Cloud Sync Button -->
                        <button onclick="document.getElementById('auth-overlay').classList.remove('hidden')" class="text-xs bg-black/20 backdrop-blur-sm p-1.5 rounded-full border border-white/20 shadow-sm text-white hover:bg-white/10 transition" title="Bulut Kaydı">
                            <i class="fas fa-cloud"></i>
                        </button>
                        <div id="active-hatim-display" class="hidden-force text-xs bg-black/20 backdrop-blur-sm px-3 py-1.5 rounded-full border border-white/20 shadow-sm flex items-center gap-2">
                            <i class="fas fa-bookmark text-yellow-300 text-[10px]"></i> <span id="active-hatim-name" class="truncate max-w-[80px] font-medium text-white"></span>
                        </div>
                    </div>
                </div>

                <!-- 2. Expanded Content (The Prayer Card) -->
                <div id="header-expanded-content">
                    <div class="flex justify-between items-start mb-4 bg-white/10 p-3 rounded-xl border border-white/10 backdrop-blur-sm">
                        <div>
                            <div onclick="openLocationModal()" class="flex items-center gap-1 text-xs bg-emerald-900/40 hover:bg-emerald-800/60 cursor-pointer px-2 py-1 rounded-lg transition border border-white/10">
                                <i class="fas fa-map-marker-alt text-yellow-300"></i>
                                <span id="location-display" class="font-medium truncate max-w-[120px]">Konum Seçiniz</span>
                                <i class="fas fa-chevron-down text-[10px] opacity-70"></i>
                            </div>
                            <div class="mt-2">
                                <span class="text-xs opacity-80 block text-emerald-100">Sıradaki Vakit</span>
                                <div class="text-2xl font-bold tracking-tight text-white drop-shadow-sm" id="next-prayer-name">--</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-xs opacity-80 block text-emerald-100">Kalan Süre</span>
                            <div class="text-4xl font-mono font-bold text-yellow-300 drop-shadow-md" style="font-family: 'Courier New', monospace;" id="countdown-timer">--:--:--</div>
                        </div>
                    </div>

                    <!-- Vakitler Listesi -->
                    <div class="flex justify-between items-center text-[10px] bg-black/20 rounded-xl p-2 overflow-x-auto no-scrollbar border border-white/5" id="prayer-times-list">
                        <div class="w-full text-center py-2 opacity-80">Vakitler yükleniyor...</div>
                    </div>
                </div>

                <!-- 3. Collapsed Content (Compact View) -->
                <div id="header-collapsed-content" class="hidden flex-col items-center justify-center text-center">
                    <div class="flex items-center gap-2 text-lg font-bold">
                        <span id="collapsed-prayer-name">--</span>
                        <span class="text-yellow-300" id="collapsed-prayer-time">--:--</span>
                    </div>
                    <div class="text-xs opacity-90 font-mono text-emerald-100" id="collapsed-countdown">--:--:--</div>
                </div>
            </div>
        </header>

        <!-- Main -->
        <main class="flex-1 overflow-hidden bg-gray-50 relative">
            
            <!-- GÜNLÜK TAB -->
            <div id="tab-home" class="tab-content active overflow-y-auto p-4 space-y-4 pb-32">
                
                <!-- Günün Ayeti -->
                <div class="bg-white/80 rounded-xl p-4 border border-emerald-100 shadow-sm shrink-0 mt-2 bg-[url('https://www.transparenttextures.com/patterns/subtle-white-feathers.png')]">
                    <h2 class="font-bold text-emerald-800 text-sm mb-2 flex items-center"><i class="fas fa-book-open mr-2 text-emerald-600"></i> Günün Ayeti</h2>
                    <p class="text-sm italic text-gray-600 leading-relaxed font-serif">"Ey iman edenler! Allah'a karşı gelmekten sakının ve doğrularla beraber olun." (Tevbe, 119)</p>
                    <div class="mt-3 text-xs text-right text-emerald-600 font-medium">Ramazan'a <span id="days-left" class="font-bold text-amber-500 text-sm">--</span> gün kaldı</div>
                </div>

                <!-- 1. Namaz Takibi -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 shrink-0 overflow-hidden">
                    <div onclick="toggleAccordion('acc-prayer', 'icon-prayer')" class="p-4 flex justify-between items-center cursor-pointer bg-white select-none hover:bg-gray-50 transition border-l-4 border-l-emerald-500">
                        <h3 class="font-bold text-gray-700 flex items-center"><i class="fas fa-mosque text-emerald-500 mr-2"></i>Namaz Takibi</h3>
                        <i id="icon-prayer" class="fas fa-chevron-down text-gray-400 transition-transform duration-300"></i>
                    </div>
                    <div id="acc-prayer" class="accordion-content">
                        <div class="px-4 pb-4 space-y-2 pt-2" id="prayer-tracker-list"></div>
                    </div>
                </div>

                <!-- 2. Kuran-ı Kerim -->
                <div id="daily-quran-card" class="bg-white rounded-xl shadow-sm border border-gray-100 shrink-0 overflow-hidden transition-all duration-300">
                    <div onclick="toggleAccordion('acc-quran', 'icon-quran')" class="p-4 flex justify-between items-center cursor-pointer select-none hover:bg-opacity-50 transition border-l-4 border-l-emerald-500">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-quran text-emerald-500"></i>
                            <h3 class="font-bold text-gray-700">Kuran-ı Kerim</h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="quran-status-badge" class="hidden text-[10px] font-bold bg-emerald-100 text-emerald-600 px-2 py-1 rounded-full">Okundu</span>
                            <i id="icon-quran" class="fas fa-chevron-down text-gray-400 transition-transform duration-300"></i>
                        </div>
                    </div>
                    <div id="acc-quran" class="accordion-content">
                        <div class="px-4 pb-4 pt-2">
                            <p class="text-xs text-gray-500 mb-3">Günlük en az 5 sayfa kuranı kerim okumanız tavsiye edilir.</p>
                            <div class="flex items-center justify-between gap-3">
                                <button onclick="continueReading()" class="flex-1 bg-emerald-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-emerald-700 transition flex items-center justify-center gap-2 shadow-md shadow-emerald-200">
                                    <i class="fas fa-book-open"></i> Kaldığım Yerden Devam Et
                                </button>
                                <div class="flex items-center gap-2 bg-gray-50 rounded-lg p-1 border border-gray-200">
                                    <button onclick="updateDailyQuranPage(-1)" class="w-7 h-7 flex items-center justify-center bg-white rounded shadow-sm text-gray-600 hover:text-red-500 font-bold">-</button>
                                    <span id="daily-quran-count" class="text-sm font-bold w-6 text-center text-gray-800">0</span>
                                    <button onclick="updateDailyQuranPage(1)" class="w-7 h-7 flex items-center justify-center bg-white rounded shadow-sm text-emerald-600 hover:text-emerald-700 font-bold">+</button>
                                </div>
                            </div>
                            <div id="special-quran-tasks" class="mt-4 pt-3 border-t border-gray-100 space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- 3. Günlük Zikirler -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 shrink-0 overflow-hidden">
                    <div onclick="toggleAccordion('acc-dhikr', 'icon-dhikr')" class="p-4 flex justify-between items-center cursor-pointer bg-white select-none hover:bg-gray-50 transition border-l-4 border-l-emerald-500">
                        <h3 class="font-bold text-gray-700 flex items-center"><i class="fas fa-fingerprint text-emerald-500 mr-2"></i>Günlük Zikirler</h3>
                        <i id="icon-dhikr" class="fas fa-chevron-down text-gray-400 transition-transform duration-300"></i>
                    </div>
                    <div id="acc-dhikr" class="accordion-content">
                        <div class="px-4 pb-4 space-y-2 pt-2" id="daily-dhikr-list"></div>
                    </div>
                </div>
                
                <!-- 4. Oruç Takibi -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 shrink-0 overflow-hidden">
                    <div onclick="toggleAccordion('acc-fasting', 'icon-fasting')" class="p-4 flex justify-between items-center cursor-pointer bg-white select-none hover:bg-gray-50 transition border-l-4 border-l-emerald-500">
                        <h3 class="font-bold text-gray-700 flex items-center"><i class="fas fa-sun text-emerald-500 mr-2"></i>Oruç Takibi</h3>
                        <i id="icon-fasting" class="fas fa-chevron-down text-gray-400 transition-transform duration-300"></i>
                    </div>
                    <div id="acc-fasting" class="accordion-content">
                        <div class="px-4 pb-4 pt-2">
                            <p class="text-xs text-gray-500 mb-3">Pazartesi ve Perşembe günleri oruç tutmanız tavsiye edilir.</p>
                            <div class="space-y-2" id="fasting-tracker-list"></div>
                        </div>
                    </div>
                </div>

                <!-- 5. Sadaka Takibi -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 shrink-0 overflow-hidden">
                    <div onclick="toggleAccordion('acc-sadaka', 'icon-sadaka')" class="p-4 flex justify-between items-center cursor-pointer bg-white select-none hover:bg-gray-50 transition border-l-4 border-l-emerald-500">
                        <h3 class="font-bold text-gray-700 flex items-center"><i class="fas fa-hand-holding-heart text-emerald-500 mr-2"></i>Sadaka Takibi</h3>
                        <i id="icon-sadaka" class="fas fa-chevron-down text-gray-400 transition-transform duration-300"></i>
                    </div>
                    <div id="acc-sadaka" class="accordion-content">
                        <div class="px-4 pb-4 pt-2">
                            <p class="text-xs text-gray-500 mb-3">Allah rızasını gözeterek başkalarının yararına yapmış olduğunuz en ufak iş sadakadır.</p>
                            <div id="sadaka-tracker-container"></div>
                        </div>
                    </div>
                </div>

                <!-- 6. Dini İlim Dersleri -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 shrink-0 overflow-hidden">
                    <div onclick="toggleAccordion('acc-study', 'icon-study')" class="p-4 flex justify-between items-center cursor-pointer bg-white select-none hover:bg-gray-50 transition border-l-4 border-l-emerald-500">
                        <h3 class="font-bold text-gray-700 flex items-center"><i class="fas fa-book-open text-emerald-500 mr-2"></i>Dini İlim Dersleri</h3>
                        <i id="icon-study" class="fas fa-chevron-down text-gray-400 transition-transform duration-300"></i>
                    </div>
                    <div id="acc-study" class="accordion-content">
                        <div class="px-4 pb-4 pt-2">
                            <p class="text-xs text-gray-500 mb-3">Allah rızası için dini bilgilerinizi geliştirmek amacıyla yapmış olduğunuz her türlü okuma öğrenme (Haftalık).</p>
                            <div id="religious-study-tracker-container"></div>
                        </div>
                    </div>
                </div>

                <!-- 7. Kelime-i Tevhid -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 shrink-0 overflow-hidden">
                    <div onclick="toggleAccordion('acc-tevhid', 'icon-tevhid')" class="p-4 flex justify-between items-center cursor-pointer bg-white select-none hover:bg-gray-50 transition border-l-4 border-l-emerald-500">
                        <h3 class="font-bold text-gray-700 flex items-center"><i class="fas fa-infinity text-emerald-500 mr-2"></i>Kelime-i Tevhid Hatmi</h3>
                        <i id="icon-tevhid" class="fas fa-chevron-down text-gray-400 transition-transform duration-300"></i>
                    </div>
                    <div id="acc-tevhid" class="accordion-content">
                        <div class="px-4 pb-4 pt-2">
                            <div id="tevhid-hatmi-container" class="cursor-pointer border rounded-lg p-3 bg-emerald-50 border-emerald-100 hover:bg-emerald-100 transition select-none mb-3" onclick="startTevhidSession()">
                                <div class="flex justify-between items-center">
                                    <p class="text-sm font-bold text-emerald-800">Lâ ilâhe illallâh</p>
                                    <span id="tevhid-display-count" class="text-xs font-bold text-emerald-600">0/70000</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                                    <div id="tevhid-progress" class="bg-emerald-500 h-1.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <input type="number" id="manual-tevhid-input" placeholder="Sayı ekle..." class="flex-1 text-sm p-2 border border-gray-200 rounded-lg outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition">
                                <button onclick="addManualTevhid()" class="bg-emerald-600 text-white px-3 py-2 rounded-lg text-sm font-bold hover:bg-emerald-700 transition"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KURAN TAB (Değişiklik Yok) -->
            <div id="tab-quran" class="tab-content flex-col h-full bg-white relative">
                <div id="normal-ui" class="flex flex-col h-full">
                    <div class="sticky top-0 bg-white/95 backdrop-blur z-30 shadow-sm border-b border-emerald-50 pb-2 flex flex-col">
                        <div class="flex items-center px-3 py-2 gap-3 relative">
                            <div class="relative flex-1">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i>
                                <input type="text" id="unified-search" oninput="handleSearchInput(this.value)" onfocus="handleSearchInput(this.value)" placeholder="Sure, Cüz, Sayfa..." class="w-full pl-8 pr-2 py-2 bg-gray-50 border border-gray-200 rounded-xl text-xs focus:ring-2 focus:ring-emerald-500 outline-none shadow-sm transition">
                                <div id="search-suggestions" class="hidden"></div>
                            </div>
                            <div class="text-right flex flex-col justify-center min-w-[90px]">
                                <span id="current-surah-info" class="text-sm font-bold text-emerald-800 leading-tight">Fâtiha</span>
                                <span id="current-juz-info" class="text-[10px] text-gray-500 font-medium tracking-wide">1. Cüz</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between px-3 gap-2 h-10 relative">
                            <div class="flex items-center gap-1 bg-gray-50 p-0.5 rounded-xl border border-gray-100">
                                <button onclick="changePage(-1)" class="w-8 h-8 flex items-center justify-center bg-white rounded-lg text-gray-500 hover:text-emerald-600 shadow-sm"><i class="fas fa-chevron-left text-xs"></i></button>
                                <span class="text-xs font-bold w-9 text-center text-gray-700 page-badge" id="page-num">0</span>
                                <button onclick="changePage(1)" class="w-8 h-8 flex items-center justify-center bg-white rounded-lg text-gray-500 hover:text-emerald-600 shadow-sm"><i class="fas fa-chevron-right text-xs"></i></button>
                            </div>
                            <div id="default-tools" class="flex items-center gap-2 overflow-x-auto no-scrollbar p-1">
                                <button onclick="saveHatimLocation()" class="tool-btn" title="Kaydet"><i class="fas fa-bookmark"></i></button>
                                <button onclick="openModal('hatimListModal')" class="tool-btn" title="Hatimler"><i class="fas fa-layer-group"></i></button>
                                <button onclick="toggleAutoScroll()" class="tool-btn" title="Oto Kaydır"><i class="fas fa-circle-play"></i></button>
                                <button onclick="openTranslation()" class="tool-btn" title="Meal"><i class="fas fa-book-open"></i></button>
                                <button onclick="toggleReadingMode()" class="tool-btn" title="Okuma Modu"><i class="fas fa-expand"></i></button>
                            </div>
                            <div id="scroll-tools" class="hidden-force flex items-center gap-2 bg-white flex-1 justify-end p-1">
                                <div class="flex items-center gap-2 bg-emerald-50 px-2 py-1 rounded-full border border-emerald-100">
                                    <button onclick="adjustScrollSpeed(-1)" class="speed-btn" title="Yavaşlat">-</button>
                                    <span id="speed-display" class="text-xs font-bold text-emerald-700 w-6 text-center">10</span>
                                    <button onclick="adjustScrollSpeed(1)" class="speed-btn" title="Hızlandır">+</button>
                                </div>
                                <button onclick="toggleAutoScroll()" class="w-9 h-9 flex items-center justify-center rounded-full bg-red-50 text-red-500 border border-red-100 hover:bg-red-100 transition shadow-sm" title="Durdur">
                                    <i class="fas fa-stop text-sm"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="quran-display" class="quran-container flex-1 overflow-y-auto bg-gray-50 pb-36 relative text-center">
                        <div id="arabic-page" class="w-full min-h-full flex flex-col items-center justify-start py-2">
                             <img id="quran-page-image" src="" alt="Kuran Sayfası" class="max-w-full w-auto h-auto shadow-sm rounded-sm" style="max-height: 100%;">
                        </div>
                    </div>
                </div>
                <div id="reading-mode-layout" class="hidden h-full w-full bg-[#fffdf5]">
                    <div id="reading-display" class="no-scrollbar"></div>
                    <div class="reading-sidebar">
                        <button onclick="toggleReadingMode()" class="reading-mode-toggle-btn active" title="Çıkış (Normal Moda Dön)">
                            <i class="fas fa-compress text-lg"></i>
                        </button>
                        <div class="reading-info-box">
                            <span class="reading-info-item" id="reading-juz-info">1. Cüz</span>
                            <span class="reading-info-item" style="color:#059669;" id="reading-surah-info">Fâtiha</span>
                            <span class="reading-info-item text-lg font-extrabold" id="reading-page-info">0</span>
                        </div>
                        <div class="flex flex-col items-center gap-2 w-full mt-2">
                             <button onclick="adjustScrollSpeed(1)" class="speed-btn w-8 h-8 text-xs">+</button>
                             <span id="speed-display-reading" class="text-sm font-bold text-emerald-700">10</span>
                             <button onclick="adjustScrollSpeed(-1)" class="speed-btn w-8 h-8 text-xs">-</button>
                        </div>
                        <button onclick="toggleAutoScroll()" id="reading-play-btn" class="reading-mode-toggle-btn" style="margin-top:auto; margin-bottom:10px;">
                            <i class="fas fa-play text-lg"></i>
                        </button>
                    </div>
                </div>
                <div id="translation-overlay" class="hidden absolute inset-0 top-[110px] bg-white z-40 flex flex-col animate-fadeIn shadow-[0_-10px_40px_rgba(0,0,0,0.1)] rounded-t-3xl border-t border-emerald-100">
                     <div class="bg-emerald-50/80 backdrop-blur p-4 flex justify-between items-center border-b border-emerald-100 rounded-t-3xl">
                        <h3 class="font-bold text-emerald-800 text-sm flex items-center gap-2"><i class="fas fa-language"></i> Sayfa <span id="trans-page-num">0</span> Meali</h3>
                        <button onclick="closeTranslation()" class="w-8 h-8 flex items-center justify-center bg-white rounded-full text-emerald-600 hover:text-red-500 hover:bg-red-50 transition shadow-sm"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="translation-content" class="flex-1 overflow-y-auto p-5 space-y-4 pb-24 text-sm leading-relaxed text-gray-700"></div>
                </div>
                <div id="quran-loader" class="hidden absolute inset-0 top-[110px] bg-white/95 flex flex-col items-center justify-center z-50">
                    <i class="fas fa-circle-notch fa-spin text-emerald-600 text-3xl"></i>
                    <p class="text-sm text-gray-500 mt-3 font-medium">Sayfa Yükleniyor...</p>
                </div>
            </div>

            <!-- ZİKİR TAB -->
            <div id="tab-zikir" class="tab-content h-full relative overflow-hidden bg-slate-50 select-none pb-24">
                <!-- İçerik aynı -->
                <div id="dhikr-info-bar" class="absolute top-4 left-4 right-4 z-40 flex justify-center hidden">
                     <div class="bg-white/95 backdrop-blur px-4 py-2 rounded-xl shadow-lg border border-emerald-100 w-full max-w-sm flex items-center justify-between gap-3">
                        <p id="current-dhikr-name" class="text-xs font-bold text-emerald-900 leading-snug line-clamp-2 flex-1"></p>
                        <div class="flex items-center gap-1 bg-emerald-50 px-2 py-1 rounded-lg border border-emerald-100 shrink-0">
                            <span id="counter-display" class="text-xl font-bold text-emerald-600 font-mono">0</span>
                            <span id="target-display" class="text-xs text-gray-400 font-medium">/33</span>
                        </div>
                    </div>
                </div>
                <div id="free-mode-counter" class="absolute top-4 right-4 z-40 hidden">
                    <div class="bg-white/90 backdrop-blur px-3 py-2 rounded-xl shadow-sm border border-emerald-100">
                        <span id="free-counter-display" class="text-2xl font-bold text-emerald-600 font-mono">0</span>
                    </div>
                </div>
                <div class="tesbih-container" id="touch-area">
                    <div class="tesbih-string"></div>
                    <div id="bead-chain" class="bead-wrapper">
                        <div class="bead" style="top: 0px;"></div>
                        <div class="bead" style="top: 55px;"></div>
                        <div class="bead active" id="active-bead" style="top: 110px;"></div>
                        <div class="bead" style="top: 280px;"></div>
                        <div class="bead" style="top: 335px;"></div>
                        <div class="bead" style="top: 390px;"></div>
                    </div>
                </div>
                <div id="dhikr-selection" class="hidden"></div>
            </div>

            <!-- BORÇLAR TAB (Değişiklik Yok) -->
            <div id="tab-borclar" class="tab-content h-full overflow-y-auto bg-gray-50 pb-32 p-4">
                <!-- İçerik aynı -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-4">
                    <h3 class="font-bold text-gray-700 flex items-center mb-4 text-lg border-b pb-2"><i class="fas fa-clipboard-list text-emerald-500 mr-2"></i>Kaza Namazı Borçları</h3>
                    <div id="debt-list" class="space-y-4"></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                    <h3 class="font-bold text-gray-700 flex items-center mb-4 text-lg border-b pb-2"><i class="fas fa-sun text-emerald-500 mr-2"></i>Oruç Borcu</h3>
                    <div class="flex items-center justify-between p-3 bg-emerald-50 rounded-lg border border-emerald-100">
                        <span class="font-medium text-gray-700">Kaza Orucu</span>
                        <div class="flex items-center gap-3">
                            <button onclick="updateFastingDebt(-1)" class="debt-btn bg-emerald-100 text-emerald-700 hover:bg-emerald-200" title="Kaza Tuttum (-1)"><i class="fas fa-check"></i></button>
                            <span id="fasting-debt-display" class="text-lg font-bold w-12 text-center font-mono text-gray-800">0</span>
                            <button onclick="updateFastingDebt(1)" class="debt-btn bg-red-100 text-red-700 hover:bg-red-200" title="Borç Ekle (+1)"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Navbar (Updated Theme) -->
        <nav id="main-nav" class="bg-gradient-to-r from-emerald-800 to-teal-900 border-t border-white/20 absolute bottom-0 w-full z-40 flex justify-between items-center pb-safe px-1 shadow-2xl relative overflow-hidden">
            <!-- Arka Plan Deseni -->
            <div class="absolute inset-0 arabesque-pattern opacity-30 pointer-events-none"></div>
            
            <button onclick="switchTab('home')" class="nav-btn active flex-1 flex flex-col items-center justify-center h-full text-yellow-300 transition duration-300 py-2 relative z-10">
                <i class="fas fa-home text-xl mb-1"></i><span class="text-[10px] font-medium">Günlük</span>
            </button>
            <button onclick="switchTab('quran')" class="nav-btn flex-1 flex flex-col items-center justify-center h-full text-white/60 hover:text-white transition duration-300 py-2 relative z-10">
                <i class="fas fa-book-quran text-xl mb-1"></i><span class="text-[10px] font-medium">Kuran</span>
            </button>
            <button onclick="openFreeZikirMode()" class="nav-btn flex-1 flex flex-col items-center justify-center h-full text-white/60 hover:text-white transition duration-300 py-2 relative z-10">
                <i class="fas fa-fingerprint text-xl mb-1"></i><span class="text-[10px] font-medium">Zikir</span>
            </button>
            <button onclick="switchTab('borclar')" class="nav-btn flex-1 flex flex-col items-center justify-center h-full text-white/60 hover:text-white transition duration-300 py-2 relative z-10">
                <i class="fas fa-clipboard-list text-xl mb-1"></i><span class="text-[10px] font-medium">Borçlar</span>
            </button>
        </nav>
        
        <!-- Auth Modal (New - Email Only) -->
        <div id="auth-overlay" class="fixed inset-0 bg-emerald-900/90 z-50 flex items-center justify-center p-6 hidden">
            <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl text-center relative overflow-hidden">
                 <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-emerald-500 to-teal-600"></div>
                 <i class="fas fa-cloud-moon text-4xl text-emerald-600 mb-4 block"></i>
                 <h2 class="text-xl font-bold text-gray-800 mb-2">Verilerinizi Koruyun</h2>
                 <p class="text-sm text-gray-500 mb-6">İbadet kayıtlarınızı kaybetmemek için e-posta adresinizi girin. E-postanıza bağlı olarak otomatik kaydedilecektir.</p>
                 
                 <input type="email" id="auth-email" placeholder="E-posta Adresiniz" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl mb-4 text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
                 
                 <button onclick="handleAuth()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-emerald-200 active:scale-95 transition mb-3">
                     Başla
                 </button>
            </div>
        </div>

        <!-- Modals (Aynı) -->
        <div id="locationModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl">
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Konum Seçimi</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">Şehir</label>
                        <select id="city-select" onchange="handleCityChange()" class="w-full p-2 border rounded-lg bg-gray-50 text-sm"><option value="">Seçiniz</option></select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">İlçe</label>
                        <select id="district-select" class="w-full p-2 border rounded-lg bg-gray-50 text-sm" disabled><option value="">Önce Şehir Seçiniz</option></select>
                    </div>
                    <button onclick="saveLocation()" class="w-full bg-emerald-600 text-white py-2 rounded-lg font-bold mt-4">Kaydet</button>
                    <button onclick="closeModal('locationModal')" class="w-full text-gray-500 text-xs mt-2">İptal</button>
                </div>
            </div>
        </div>
        <div id="hatimListModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl">
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 flex justify-between items-center">Hatimlerim <button onclick="closeModal('hatimListModal')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button></h3>
                <div id="hatim-list-container" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div>
                <div class="flex gap-2">
                    <input type="text" id="new-hatim-name" placeholder="Yeni hatim ismi..." class="flex-1 p-2 border rounded-lg text-sm outline-none focus:border-emerald-500">
                    <button onclick="createNewHatim()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-emerald-700">Ekle</button>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // --- FIREBASE SETUP ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // User provided config
        const firebaseConfig = {
            apiKey: "AIzaSyC_5P4MjaA5q_TaFQFtA9qL04fJ3UyKu8g",
            authDomain: "mushaf-94211.firebaseapp.com",
            projectId: "mushaf-94211",
            storageBucket: "mushaf-94211.firebasestorage.app",
            messagingSenderId: "134676649016",
            appId: "1:134676649016:web:b5b5735072e081790182cd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'mushaf-app-v1';
        let currentUser = null;

        // Set persistence to LOCAL (Explicitly)
        setPersistence(auth, browserLocalPersistence).catch((error) => console.error("Persistence Error", error));

        // Global functions for non-module script access
        window.auth = auth;
        window.handleAuth = async () => {
            const email = document.getElementById('auth-email').value;
            // Constant password for UX simplicity as requested (Email-only login feel)
            const password = "SimulatedPasswordForUX_123!"; 
            
            if(!email) { alert("Lütfen e-posta giriniz."); return; }
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    try {
                        await createUserWithEmailAndPassword(auth, email, password);
                        // Save initial local data to cloud on first create
                        syncAllToCloud();
                    } catch (createError) {
                        alert("Kayıt oluşturulamadı: " + createError.message);
                    }
                } else {
                    alert("Giriş hatası: " + error.message);
                }
            }
        };

        window.closeAuthModal = () => {
            document.getElementById('auth-overlay').classList.add('hidden');
        };

        // Auth Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-overlay').classList.add('hidden');
                // Load Data from Cloud
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'mainData');
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        // Restore keys to localStorage
                        Object.keys(data).forEach(key => {
                            localStorage.setItem(key, data[key]);
                        });
                        // Refresh UI
                        window.location.reload(); 
                    }
                } catch(e) { console.error("Veri çekme hatası", e); }
            } else {
                // Check if user has skipped before? For now show always if not logged in
                // Or check if localStorage has data to determine if it's first run
                if (!localStorage.getItem('hatimList')) { 
                    // New user or cleared cache
                    document.getElementById('auth-overlay').classList.remove('hidden');
                }
            }
        });

        // Unified Save Function (Replaces localStorage.setItem calls)
        window.saveLocalAndRemote = async (key, value) => {
             // 1. Save Local
             localStorage.setItem(key, typeof value === 'object' ? JSON.stringify(value) : value);
             
             // 2. Sync Cloud
             if (!currentUser) return;
             try {
                 const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'data', 'mainData');
                 const update = {};
                 // Ensure we store strings to match localStorage behavior exactly
                 update[key] = typeof value === 'object' ? JSON.stringify(value) : value; 
                 await setDoc(docRef, { [key]: update[key] }, { merge: true });
            } catch(e) { console.error("Sync error", e); }
        };
        
        function syncAllToCloud() {
            if (!currentUser) return;
            const keysToSync = ['prayerDebts', 'fastingDebt', 'hatimList', 'tevhid_hatmi_total', 'freeDhikrCount', 'userLocation', `daily_quran_${new Date().toLocaleDateString()}`];
            keysToSync.forEach(key => {
                const val = localStorage.getItem(key);
                if(val) window.saveLocalAndRemote(key, val); // Reuse helper
            });
        }
    </script>

    <script>
        // --- SCROLL ANIMATION FOR HEADER ---
        document.addEventListener('DOMContentLoaded', () => {
            const tabHome = document.getElementById('tab-home');
            const body = document.body;
            
            if(tabHome) {
                tabHome.addEventListener('scroll', () => {
                    const scrollPos = tabHome.scrollTop;
                    if (scrollPos > 30) {
                        body.classList.add('header-shrunk');
                    } else {
                        body.classList.remove('header-shrunk');
                    }
                });
            }
        });

        // --- ACCORDION FUNCTIONALITY ---
        function toggleAccordion(contentId, iconId) {
            const allContents = document.querySelectorAll('.accordion-content');
            const allIcons = document.querySelectorAll('.fa-chevron-down');

            // Close all others
            allContents.forEach(content => {
                if (content.id !== contentId) {
                    content.style.maxHeight = null;
                    content.classList.remove('open');
                }
            });
            allIcons.forEach(icon => {
                if (icon.id !== iconId) {
                    icon.classList.remove('rotate-180');
                }
            });

            // Toggle current
            const content = document.getElementById(contentId);
            const icon = document.getElementById(iconId);
            
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                content.classList.remove('open');
                icon.classList.remove('rotate-180');
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
                content.classList.add('open');
                icon.classList.add('rotate-180');
            }
        }

        // --- HELPER & DATA ---
        function normalizeTr(text) { return text.toLocaleLowerCase('tr').replace(/â/g, 'a').replace(/î/g, 'i').replace(/û/g, 'u'); }
        const TURKEY_CITIES = { "Adana":["Aladağ","Ceyhan","Çukurova","Feke","İmamoğlu","Karaisalı","Karataş","Kozan","Pozantı","Saimbeyli","Sarıçam","Seyhan","Tufanbeyli","Yumurtalık","Yüreğir"], "Adıyaman":["Besni","Çelikhan","Gerger","Gölbaşı","Kahta","Merkez","Samsat","Sincik","Tut"], "Afyonkarahisar":["Başmakçı","Bayat","Bolvadin","Çay","Çobanlar","Dazkırı","Dinar","Emirdağ","Evciler","Hocalar","İhsaniye","İscehisar","Kızılören","Merkez","Sandıklı","Sinanpaşa","Sultandağı","Şuhut"], "Ağrı":["Diyadin","Doğubayazıt","Eleşkirt","Hamur","Merkez","Patnos","Taşlıçay","Tutak"], "Aksaray":["Ağaçören","Eskil","Gülağaç","Güzelyurt","Merkez","Ortaköy","Sarıyahşi","Sultanhanı"], "Amasya":["Göynücek","Gümüşhacıköy","Hamamözü","Merkez","Merzifon","Suluova","Taşova"], "Ankara":["Akyurt","Altındağ","Ayaş","Bala","Beypazarı","Çamlıdere","Çankaya","Çubuk","Elmadağ","Etimesgut","Evren","Gölbaşı","Güdül","Haymana","Kalecik","Kahramankazan","Keçiören","Kızılcahamam","Mamak","Nallıhan","Polatlı","Pursaklar","Sincan","Şereflikoçhisar","Yenimahalle"], "Antalya":["Akseki","Aksu","Alanya","Demre","Döşemealtı","Elmalı","Finike","Gazipaşa","Gündoğmuş","İbradı","Kaş","Kemer","Kepez","Konyaaltı","Korkuteli","Kumluca","Manavgat","Muratpaşa","Serik"], "Ardahan":["Çıldır","Damal","Göle","Hanak","Merkez","Posof"], "Artvin":["Ardanuç","Arhavi","Borçka","Hopa","Kemalpaşa","Merkez","Murgul","Şavşat","Yusufeli"], "Aydın":["Bozdoğan","Buharkent","Çine","Didim","Efeler","Germencik","İncirliova","Karacasu","Karpuzlu","Koçarlı","Köşk","Kuşadası","Kuyucak","Nazilli","Söke","Sultanhisar","Yenipazar"], "Balıkesir":["Altıeylül","Ayvalık","Balya","Bandırma","Bigadiç","Burhaniye","Dursunbey","Edremit","Erdek","Gömeç","Gönen","Havran","İvrindi","Karesi","Kepsut","Manyas","Marmara","Savaştepe","Sındırgı","Susurluk"], "Bartın":["Amasra","Kurucaşile","Merkez","Ulus"], "Batman":["Beşiri","Gercüş","Hasankeyf","Kozluk","Merkez","Sason"], "Bayburt":["Aydıntepe","Demirözü","Merkez"], "Bilecik":["Bozüyük","Gölpazarı","İnhisar","Merkez","Osmaneli","Pazaryeri","Söğüt","Yenipazar"], "Bingöl":["Adaklı","Genç","Karlıova","Kiğı","Merkez","Solhan","Yayladere","Yedisu"], "Bitlis":["Adilcevaz","Ahlat","Güroymak","Hizan","Merkez","Mutki","Tatvan"], "Bolu":["Dörtdivan","Gerede","Göynük","Kıbrıscık","Mengen","Merkez","Mudurnu","Seben","Yeniçağa"], "Burdur":["Ağlasun","Altınyayla","Bucak","Çavdır","Çeltikçi","Gölhisar","Karamanlı","Kemer","Merkez","Tefenni","Yeşilova"], "Bursa":["Büyükorhan","Gemlik","Gürsu","Harmancık","İnegöl","İznik","Karacabey","Keles","Kestel","Mudanya","Mustafakemalpaşa","Nilüfer","Orhaneli","Orhangazi","Osmangazi","Yenişehir","Yıldırım"], "Çanakkale":["Ayvacık","Bayramiç","Biga","Bozcaada","Çan","Eceabat","Ezine","Gelibolu","Gökçeada","Lapseki","Merkez","Yenice"], "Çankırı":["Atkaracalar","Bayramören","Çerkeş","Eldivan","Ilgaz","Kızılırmak","Korgun","Kurşunlu","Merkez","Orta","Şabanözü","Yapraklı"], "Çorum":["Alaca","Bayat","Boğazkale","Dodurga","İskilip","Kargı","Laçin","Mecitözü","Merkez","Oğuzlar","Ortaköy","Osmancık","Sungurlu","Uğurludağ"], "Denizli":["Acıpayam","Babadağ","Baklan","Bekilli","Beyağaç","Bozkurt","Buldan","Çal","Çameli","Çardak","Çivril","Güney","Honaz","Kale","Merkezefendi","Pamukkale","Sarayköy","Serinhisar","Tavas"], "Diyarbakır":["Bağlar","Bismil","Çermik","Çınar","Çüngüş","Dicle","Eğil","Ergani","Hani","Hazro","Kayapınar","Kocaköy","Kulp","Lice","Silvan","Sur","Yenişehir"], "Düzce":["Akçakoca","Cumayeri","Çilimli","Gölyaka","Gümüşova","Kaynaşlı","Merkez","Yığılca"], "Edirne":["Enez","Havsa","İpsala","Keşan","Lalapaşa","Meriç","Merkez","Süloğlu","Uzunköprü"], "Elazığ":["Ağın","Alacakaya","Arıcak","Baskil","Karakoçan","Keban","Kovancılar","Maden","Merkez","Palu","Sivrice"], "Erzincan":["Çayırlı","İliç","Kemah","Kemaliye","Merkez","Otlukbeli","Refahiye","Tercan","Üzümlü"], "Erzurum":["Aşkale","Aziziye","Çat","Hınıs","Horasan","İspir","Karaçoban","Karayazı","Köprüköy","Narman","Oltu","Olur","Palandöken","Pasinler","Pazaryolu","Şenkaya","Tekman","Tortum","Uzundere","Yakutiye"], "Eskişehir":["Alpu","Beylikova","Çifteler","Günyüzü","Han","İnönü","Mahmudiye","Mihalgazi","Mihalıççık","Odunpazarı","Sarıcakaya","Seyitgazi","Sivrihisar","Tepebaşı"], "Gaziantep":["Araban","İslahiye","Karkamış","Nizip","Nurdağı","Oğuzeli","Şahinbey","Şehitkamil","Yavuzeli"], "Giresun":["Alucra","Bulancak","Çamoluk","Çanakçı","Dereli","Doğankent","Espiye","Eynesil","Görele","Güce","Keşap","Merkez","Piraziz","Şebinkarahisar","Tirebolu","Yağlıdere"], "Gümüşhane":["Kelkit","Köse","Kürtün","Merkez","Şiran","Torul"], "Hakkari":["Çukurca","Derecik","Merkez","Şemdinli","Yüksekova"], "Hatay":["Altınözü","Antakya","Arsuz","Belen","Defne","Dörtyol","Erzin","Hassa","İskenderun","Kırıkhan","Kumlu","Payas","Reyhanlı","Samandağ","Yayladağı"], "İğdır":["Aralık","Karakoyunlu","Merkez","Tuzluca"], "Isparta":["Aksu","Atabey","Eğirdir","Gelendost","Gönen","Keçiborlu","Merkez","Senirkent","Sütçüler","Şarkikaraağaç","Uluborlu","Yalvaç","Yenişarbademli"], "İstanbul":["Adalar","Arnavutköy","Ataşehir","Avcılar","Bağcılar","Bahçelievler","Bakırköy","Başakşehir","Bayrampaşa","Beşiktaş","Beykoz","Beylikdüzü","Beyoğlu","Büyükçekmece","Çatalca","Çekmeköy","Esenler","Esenyurt","Eyüpsultan","Fatih","Gaziosmanpaşa","Güngören","Kadıköy","Kağıthane","Kartal","Küçükçekmece","Maltepe","Pendik","Sancaktepe","Sarıyer","Silivri","Sultanbeyli","Sultangazi","Şile","Şişli","Tuzla","Ümraniye","Üsküdar","Zeytinburnu"], "İzmir":["Aliağa","Balçova","Bayındır","Bayraklı","Bergama","Beydağ","Bornova","Buca","Çeşme","Çiğli","Dikili","Foça","Gaziemir","Güzelbahçe","Karabağlar","Karaburun","Karşıyaka","Kemalpaşa","Kınık","Kiraz","Konak","Menderes","Menemen","Narlıdere","Ödemiş","Seferihisar","Selçuk","Tire","Torbalı","Urla"], "Kahramanmaraş":["Afşin","Andırın","Çağlayancerit","Dulkadiroğlu","Ekinözü","Elbistan","Göksun","Nurhak","Onikişubat","Pazarcık","Türkoğlu"], "Karabük":["Eflani","Eskipazar","Merkez","Ovacık","Safranbolu","Yenice"], "Karaman":["Ayrancı","Başyayla","Ermenek","Kazımkarabekir","Merkez","Sarıveliler"], "Kars":["Akyaka","Arpaçay","Digor","Kağızman","Merkez","Sarıkamış","Selim","Susuz"], "Kastamonu":["Abana","Ağlı","Araç","Azdavay","Bozkurt","Cide","Çatalzeytin","Daday","Devrekani","Doğanyurt","Hanönü","İhsangazi","İnebolu","Küre","Merkez","Pınarbaşı","Seydiler","Şenpazar","Taşköprü","Tosya"], "Kayseri":["Akkışla","Bünyan","Develi","Felahiye","Hacılar","İncesu","Kocasinan","Melikgazi","Özvatan","Pınarbaşı","Sarıoğlan","Sarız","Talas","Tomarza","Yahyalı","Yeşilhisar"], "Kırıkkale":["Bahşılı","Balışeyh","Çelebi","Delice","Karakeçili","Keskin","Merkez","Sulakyurt","Yahşihan"], "Kırklareli":["Babaeski","Demirköy","Kofçaz","Lüleburgaz","Merkez","Pehlivanköy","Pınarhisar","Vize"], "Kırşehir":["Akçakent","Akpınar","Boztepe","Çiçekdağı","Kaman","Merkez","Mucur"], "Kilis":["Elbeyli","Merkez","Musabeyli","Polateli"], "Kocaeli":["Başiskele","Çayırova","Darıca","Derince","Dilovası","Gebze","Gölcük","İzmit","Kandıra","Karamürsel","Kartepe","Körfez"], "Konya":["Ahırlı","Akören","Akşehir","Altınekin","Beyşehir","Bozkır","Cihanbeyli","Çeltik","Çumra","Derbent","Derebucak","Doğanhisar","Emirgazi","Ereğli","Güneysınır","Hadim","Halkapınar","Hüyük","Ilgın","Kadınhanı","Karapınar","Karatay","Kulu","Meram","Sarayönü","Selçuklu","Seydişehir","Taşkent","Tuzlukçu","Yalıhüyük","Yunak"], "Kütahya":["Altıntaş","Aslanapa","Çavdarhisar","Domaniç","Dumlupınar","Emet","Gediz","Hisarcık","Merkez","Pazarlar","Simav","Şaphane","Tavşanlı"], "Malatya":["Akçadağ","Arapgir","Arguvan","Battalgazi","Darende","Doğanşehir","Doğanyol","Hekimhan","Kale","Kuluncak","Pütürge","Yazıhan","Yeşilyurt"], "Manisa":["Ahmetli","Akhisar","Alaşehir","Demirci","Gölmarmara","Gördes","Kırkağaç","Köprübaşı","Kula","Salihli","Sarıgöl","Saruhanlı","Selendi","Soma","Şehzadeler","Turgutlu","Yunusemre"], "Mardin":["Artuklu","Dargeçit","Derik","Kızıltepe","Mazıdağı","Midyat","Nusaybin","Ömerli","Savur","Yeşilli"], "Mersin":["Akdeniz","Anamur","Aydıncık","Bozyazı","Çamlıyayla","Erdemli","Gülnar","Mezitli","Mut","Silifke","Tarsus","Toroslar","Yenişehir"], "Muğla":["Bodrum","Dalaman","Datça","Fethiye","Kavaklıdere","Köyceğiz","Marmaris","Menteşe","Milas","Ortaca","Seydikemer","Ula","Yatağan"], "Muş":["Bulanık","Hasköy","Korkut","Malazgirt","Merkez","Varto"], "Nevşehir":["Acıgöl","Avanos","Derinkuyu","Gülşehir","Hacıbektaş","Kozaklı","Merkez","Ürgüp"], "Niğde":["Altunhisar","Bor","Çamardı","Çiftlik","Merkez","Ulukışla"], "Ordu":["Akkuş","Altınordu","Aybastı","Çamaş","Çatalpınar","Çaybaşı","Fatsa","Gölköy","Gülyalı","Gürgentepe","İkizce","Kabadüz","Kabataş","Korgan","Kumru","Mesudiye","Perşembe","Ulubey","Ünye"], "Osmaniye":["Bahçe","Düziçi","Hasanbeyli","Kadirli","Merkez","Sumbas","Toprakkale"], "Rize":["Ardeşen","Çamlıhemşin","Çayeli","Derepazarı","Fındıklı","Güneysu","Hemşin","İkizdere","İyidere","Kalkandere","Merkez","Pazar"], "Sakarya":["Adapazarı","Akyazı","Arifiye","Erenler","Ferizli","Geyve","Hendek","Karapürçek","Karasu","Kaynarca","Kocaali","Pamukova","Sapanca","Serdivan","Söğütlü","Taraklı"], "Samsun":["19 Mayıs","Alaçam","Asarcık","Atakum","Ayvacık","Bafra","Canik","Çarşamba","Havza","İlkadım","Kavak","Ladik","Salıpazarı","Tekkeköy","Terme","Vezirköprü","Yakakent"], "Siirt":["Baykan","Eruh","Kurtalan","Merkez","Pervari","Şirvan","Tillo"], "Sinop":["Ayancık","Boyabat","Dikmen","Durağan","Erfelek","Gerze","Merkez","Saraydüzü","Türkeli"], "Sivas":["Akıncılar","Altınyayla","Divriği","Doğanşar","Gemerek","Gölova","Gürün","Hafik","İmranlı","Kangal","Koyulhisar","Merkez","Suşehri","Şarkışla","Ulaş","Yıldızeli","Zara"], "Şanlıurfa":["Akçakale","Birecik","Bozova","Ceylanpınar","Eyyübiye","Halfeti","Haliliye","Harran","Hilvan","Karaköprü","Siverek","Suruç","Viranşehir"], "Şırnak":["Beytüşşebap","Cizre","Güçlükonak","İdil","Merkez","Silopi","Uludere"], "Tekirdağ":["Çerkezköy","Çorlu","Ergene","Hayrabolu","Kapaklı","Malkara","Marmaraereğlisi","Muratlı","Saray","Süleymanpaşa","Şarköy"], "Tokat":["Almus","Artova","Başçiftlik","Erbaa","Merkez","Niksar","Pazar","Reşadiye","Sulusaray","Turhal","Yeşilyurt","Zile"], "Trabzon":["Akçaabat","Araklı","Arsin","Beşikdüzü","Çarşıbaşı","Çaykara","Dernekpazarı","Düzköy","Hayrat","Köprübaşı","Maçka","Of","Ortahisar","Sürmene","Şalpazarı","Tonya","Vakfıkebir","Yomra"], "Tunceli":["Çemişgezek","Hozat","Mazgirt","Merkez","Nazımiye","Ovacık","Pertek","Pülümür"], "Uşak":["Banaz","Eşme","Karahallı","Merkez","Sivaslı","Ulubey"], "Van":["Bahçesaray","Başkale","Çaldıran","Çatak","Edremit","Erciş","Gevaş","Gürpınar","İpekyolu","Muradiye","Özalp","Saray","Tuşba"], "Yalova":["Altınova","Armutlu","Çınarcık","Çiftlikköy","Merkez","Termal"], "Yozgat":["Akdağmadeni","Aydıncık","Boğazlıyan","Çandır","Çayıralan","Çekerek","Kadışehri","Merkez","Saraykent","Sarıkaya","Sorgun","Şefaatli","Yenifakılı","Yerköy"], "Zonguldak":["Alaplı","Çaycuma","Devrek","Ereğli","Gökçebey","Kilimli","Kozlu","Merkez"] };
        
        const fastingTasks = [
            { key: 'nafile', label: 'Bugün nafile oruç tutuyorum' },
            { key: 'kaza', label: 'Bugün kaza orucu tutuyorum' }
        ];
        
        const dailyDhikrs = [{ id: 'd1', text: "Estağfirullâhe'l-azîm ellezî lâ ilâhe illâ hüve'l-hayye'l-kayyûme ve etûbü ileyh", target: 33 }, { id: 'd2', text: "Allâhümme salli alâ seyyidinâ Muhammedin ve alâ âli seyyidinâ Muhammed", target: 33 }, { id: 'd3', text: "Lâ ilâhe illallâh Muhammedün Resûlullâh", target: 33 }, { id: 'd4', text: "Lâ havle ve lâ kuvvete illâ billâhi'l-aliyyi'l-azîm", target: 33 }, { id: 'd5', text: "Hasbünallâhu ve ni'me'l-vekîl", target: 33 }, { id: 'd6', text: "Sübhânallâhi ve bi-hamdihî sübhânallâhi'l-azîm", target: 33 }, { id: 'd7', text: "Sübhânallâh, Elhamdülillâh, Allâhü Ekber", target: 33 }];
        const prayers = [{ key: 'Fajr', label: 'Sabah Namazı' }, { key: 'Dhuhr', label: 'Öğle Namazı' }, { key: 'Asr', label: 'İkindi Namazı' }, { key: 'Maghrib', label: 'Akşam Namazı' }, { key: 'Isha', label: 'Yatsı Namazı' }, { key: 'Tahajjud', label: 'Teheccüd Namazı' }];
        const surahList = [{id:1,name:"Fâtiha",page:0},{id:2,name:"Bakara",page:1},{id:3,name:"Âl-i İmrân",page:49},{id:4,name:"Nisâ",page:76},{id:5,name:"Mâide",page:105},{id:6,name:"En'âm",page:127},{id:7,name:"A'râf",page:150},{id:8,name:"Enfâl",page:176},{id:9,name:"Tevbe",page:186},{id:10,name:"Yûnus",page:207},{id:11,name:"Hûd",page:220},{id:12,name:"Yûsuf",page:234},{id:13,name:"Ra'd",page:248},{id:14,name:"İbrahim",page:254},{id:15,name:"Hicr",page:261},{id:16,name:"Nahl",page:266},{id:17,name:"İsrâ",page:281},{id:18,name:"Kehf",page:292},{id:19,name:"Meryem",page:304},{id:20,name:"Tâhâ",page:311},{id:21,name:"Enbiyâ",page:321},{id:22,name:"Hac",page:331},{id:23,name:"Mü'minûn",page:341},{id:24,name:"Nûr",page:349},{id:25,name:"Furkan",page:358},{id:26,name:"Şuarâ",page:366},{id:27,name:"Neml",page:376},{id:28,name:"Kasas",page:384},{id:29,name:"Ankebût",page:395},{id:30,name:"Rûm",page:403},{id:31,name:"Lokmân",page:410},{id:32,name:"Secde",page:414},{id:33,name:"Ahzâb",page:417},{id:34,name:"Sebe'",page:427},{id:35,name:"Fâtır",page:433},{id:36,name:"Yâsîn",page:439},{id:37,name:"Sâffât",page:445},{id:38,name:"Sâd",page:452},{id:39,name:"Zümer",page:457},{id:40,name:"Mü'min",page:466},{id:41,name:"Fussilet",page:476},{id:42,name:"Şûrâ",page:482},{id:43,name:"Zuhruf",page:488},{id:44,name:"Duhân",page:495},{id:45,name:"Câsiye",page:498},{id:46,name:"Ahkâf",page:501},{id:47,name:"Muhammed",page:506},{id:48,name:"Fetih",page:510},{id:49,name:"Hucurât",page:514},{id:50,name:"Kâf",page:517},{id:51,name:"Zâriyât",page:519},{id:52,name:"Tûr",page:522},{id:53,name:"Necm",page:525},{id:54,name:"Kamer",page:527},{id:55,name:"Rahmân",page:530},{id:56,name:"Vâkıa",page:533},{id:57,name:"Hadîd",page:536},{id:58,name:"Mücâdele",page:541},{id:59,name:"Haşr",page:544},{id:60,name:"Mümtehine",page:548},{id:61,name:"Saff",page:550},{id:62,name:"Cuma",page:552},{id:63,name:"Münâfikûn",page:553},{id:64,name:"Teğâbün",page:555},{id:65,name:"Talâk",page:557},{id:66,name:"Tahrîm",page:559},{id:67,name:"Mülk",page:561},{id:68,name:"Kalem",page:563},{id:69,name:"Hâkka",page:565},{id:70,name:"Meâric",page:567},{id:71,name:"Nûh",page:569},{id:72,name:"Cin",page:571},{id:73,name:"Müzzemmil",page:573},{id:74,name:"Müddessir",page:574},{id:75,name:"Kıyâme",page:576},{id:76,name:"İnsân",page:577},{id:77,name:"Mürselât",page:579},{id:78,name:"Nebe'",page:581},{id:79,name:"Nâziât",page:582},{id:80,name:"Abese",page:584},{id:81,name:"Tekvîr",page:585},{id:82,name:"İnfitâr",page:586},{id:83,name:"Mutaffifîn",page:586},{id:84,name:"İnşikâk",page:588},{id:85,name:"Burûc",page:589},{id:86,name:"Târık",page:590},{id:87,name:"A'lâ",page:590},{id:88,name:"Gâşiye",page:591},{id:89,name:"Fecr",page:592},{id:90,name:"Beled",page:593},{id:91,name:"Şems",page:594},{id:92,name:"Leyl",page:594},{id:93,name:"Duhâ",page:595},{id:94,name:"İnşirâh",page:595},{id:95,name:"Tîn",page:596},{id:96,name:"Alak",page:596},{id:97,name:"Kadir",page:597},{id:98,name:"Beyyine",page:597},{id:99,name:"Zilzâl",page:598},{id:100,name:"Âdiyât",page:598},{id:101,name:"Kâria",page:599},{id:102,name:"Tekâsür",page:599},{id:103,name:"Asr",page:601},{id:104,name:"Hümeze",page:601},{id:105,name:"Fîl",page:601},{id:106,name:"Kureyş",page:602},{id:107,name:"Mâûn",page:602},{id:108,name:"Kevser",page:602},{id:109,name:"Kâfirûn",page:603},{id:110,name:"Nasr",page:603},{id:111,name:"Tebbet",page:603},{id:112,name:"İhlâs",page:604},{id:113,name:"Felâk",page:604},{id:114,name:"Nâs",page:604}];
        const juzList = [{id:1,page:0},{id:2,page:21},{id:3,page:41},{id:4,page:61},{id:5,page:81},{id:6,page:101},{id:7,page:121},{id:8,page:141},{id:9,page:161},{id:10,page:181},{id:11,page:201},{id:12,page:221},{id:13,page:241},{id:14,page:261},{id:15,page:281},{id:16,page:301},{id:17,page:321},{id:18,page:341},{id:19,page:361},{id:20,page:381},{id:21,page:401},{id:22,page:421},{id:23,page:441},{id:24,page:461},{id:25,page:481},{id:26,page:501},{id:27,page:521},{id:28,page:541},{id:29,page:561},{id:30,page:581}];

        let dhikrCount = 0; let currentDhikr = null; let activeDhikrId = null; let currentQuranPage = 0; const totalPages = 604; let hatimList = []; let activeHatimId = null; let isAutoScrolling = false; let scrollSpeed = 10; let scrollFloat = 0; let animationFrameId = null; let translationDataCache = null; let prayerTimes = null; let locationData = JSON.parse(localStorage.getItem('userLocation')) || null; let lastFrameTime = 0;
        const beadClickSound = new Audio("data:audio/wav;base64,UklGRi4AAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAACAAEA/v///w==");
        function playBeadSound() { if (!beadClickSound.paused) { beadClickSound.pause(); beadClickSound.currentTime = 0; } beadClickSound.play().catch(e => console.log(e)); }

        document.addEventListener('DOMContentLoaded', () => {
            updateDate(); loadDhikrState(); initZikirGestures(); loadHatimList(); fetchPage(0);
            renderPrayerTracker(); renderDailyDhikrs(); renderTevhidHatmi(); loadDebts();
            checkAndMigrateDebts(); renderDailyQuran(); renderSpecialQuranTasks();
            renderFastingTracker(); renderSadakaTracker(); renderReligiousStudyTracker();
            if(locationData) { document.getElementById('location-display').textContent = `${locationData.district}, ${locationData.city}`; fetchPrayerTimes(locationData.city, locationData.district); } else { populateCitySelect(); }
            const addSwipeTo = (element) => { let touchStartX = 0, touchEndX = 0, touchStartY = 0, touchEndY = 0; element.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }, {passive: true}); element.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; touchEndY = e.changedTouches[0].screenY; handleSwipe(); }, {passive: true}); const handleSwipe = () => { const diffX = touchEndX - touchStartX; const diffY = touchEndY - touchStartY; if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 60) { if (diffX < 0) changePage(1); else changePage(-1); } }; };
            addSwipeTo(document.getElementById('quran-display')); if(document.getElementById('reading-display')) addSwipeTo(document.getElementById('reading-display'));
            
            // Open Prayer Tracker by default
            toggleAccordion('acc-prayer', 'icon-prayer');
        });

        // Other functions remain same
        function renderSpecialQuranTasks() { const container = document.getElementById('special-quran-tasks'); const today = new Date(); const dayOfWeek = today.getDay(); const isThursday = dayOfWeek === 4; const isFriday = dayOfWeek === 5; const taskKey = `special_tasks_${today.toLocaleDateString()}`; const savedData = JSON.parse(localStorage.getItem(taskKey)) || {}; let tasks = [{ id: 'daily_mulk', text: 'Her Gece Mülk Suresi', page: 561, icon: 'fa-moon' }]; if (isThursday) { tasks.push({ id: 'thu_yasin', text: 'Yasin Suresi (Cuma Gecesi)', page: 439, icon: 'fa-book-quran' }, { id: 'thu_mulk', text: 'Mülk Suresi (Cuma Gecesi)', page: 561, icon: 'fa-book-quran' }, { id: 'thu_nebe', text: 'Nebe Suresi (Cuma Gecesi)', page: 581, icon: 'fa-book-quran' }); } if (isFriday) { tasks.push({ id: 'fri_kehf', text: 'Kehf Suresi (Cuma Günü)', page: 292, icon: 'fa-book-quran' }, { id: 'fri_cuma', text: 'Cuma Suresi (Cuma Günü)', page: 552, icon: 'fa-book-quran' }); } let html = ''; tasks.forEach(t => { const isChecked = savedData[t.id] || false; const bgClass = isChecked ? 'bg-emerald-50 border-emerald-100' : 'bg-white border-transparent hover:bg-gray-50'; const iconHtml = isChecked ? `<div class="w-5 h-5 rounded border bg-white border-emerald-200 flex items-center justify-center"><i class="fas fa-check text-emerald-600 text-[10px]"></i></div>` : `<div class="w-5 h-5 rounded border border-gray-300 flex items-center justify-center bg-white"></div>`; const textClass = isChecked ? 'text-emerald-800 font-bold' : 'text-gray-700'; html += `<div class="flex items-center p-2 rounded-lg border ${bgClass} transition text-xs select-none gap-3"><div class="cursor-pointer" onclick="toggleSpecialTask('${t.id}')">${iconHtml}</div><span class="flex-1 cursor-pointer ${textClass}" onclick="goToSurah(${t.page})">${t.text}</span><i class="fas ${t.icon} text-emerald-200"></i></div>`; }); if(container) container.innerHTML = html; }
        function toggleSpecialTask(id) { const taskKey = `special_tasks_${new Date().toLocaleDateString()}`; const savedData = JSON.parse(localStorage.getItem(taskKey)) || {}; if (savedData[id]) delete savedData[id]; else savedData[id] = true; localStorage.setItem(taskKey, JSON.stringify(savedData)); if(window.saveLocalAndRemote) window.saveLocalAndRemote(taskKey, JSON.stringify(savedData)); renderSpecialQuranTasks(); }
        function goToSurah(page) { fetchPage(page); switchTab('quran'); }
        function getDailyQuranCount() { const key = `daily_quran_${new Date().toLocaleDateString()}`; return parseInt(localStorage.getItem(key)) || 0; }
        function updateDailyQuranPage(delta) { const key = `daily_quran_${new Date().toLocaleDateString()}`; let count = getDailyQuranCount() + delta; if(count < 0) count = 0; localStorage.setItem(key, count); if(window.saveLocalAndRemote) window.saveLocalAndRemote(key, count); renderDailyQuran(); }
        function renderDailyQuran() { const count = getDailyQuranCount(); const card = document.getElementById('daily-quran-card'); const badge = document.getElementById('quran-status-badge'); const counterDisplay = document.getElementById('daily-quran-count'); if(counterDisplay) counterDisplay.textContent = count; if(card && badge) { if(count > 0) { card.classList.remove('bg-white', 'border-gray-100'); card.classList.add('bg-emerald-50', 'border-emerald-200'); badge.classList.remove('hidden'); } else { card.classList.add('bg-white', 'border-gray-100'); card.classList.remove('bg-emerald-50', 'border-emerald-200'); badge.classList.add('hidden'); } } }
        function continueReading() { let targetId = activeHatimId; if(!targetId && hatimList.length > 0) { targetId = hatimList[0].id; } if(!targetId && hatimList.length === 0) { createNewHatim(); if(hatimList.length > 0) targetId = hatimList[0].id; } if(targetId) { setActiveHatim(targetId); switchTab('quran'); } else { alert("Lütfen önce bir hatim oluşturun."); openModal('hatimListModal'); } }
        function renderPrayerTracker() { const container = document.getElementById('prayer-tracker-list'); const todayKey = `prayers_${new Date().toLocaleDateString()}`; const savedData = JSON.parse(localStorage.getItem(todayKey)) || {}; let html = ''; prayers.forEach(prayer => { const isCompleted = savedData[prayer.key] || false; const statusClass = isCompleted ? 'completed' : 'bg-gray-50 border-gray-200 text-gray-500 hover:bg-gray-100'; html += `<div onclick="togglePrayer('${prayer.key}')" class="prayer-checkbox cursor-pointer border rounded-lg p-3 flex justify-between items-center select-none ${statusClass}"><div class="flex items-center gap-3"><div class="w-5 h-5 rounded border flex items-center justify-center ${isCompleted ? 'bg-white border-transparent' : 'border-gray-300'}"> ${isCompleted ? '<i class="fas fa-check text-emerald-600 text-xs"></i>' : ''}</div><span class="font-medium">${prayer.label}</span></div><span class="text-xs ${isCompleted ? 'font-bold' : 'font-normal opacity-70'}">${isCompleted ? 'Kılındı' : 'Kılınmadı'}</span></div>`; }); container.innerHTML = html; }
        function togglePrayer(key) { const todayKey = `prayers_${new Date().toLocaleDateString()}`; const savedData = JSON.parse(localStorage.getItem(todayKey)) || {}; if (savedData[key]) delete savedData[key]; else savedData[key] = true; localStorage.setItem(todayKey, JSON.stringify(savedData)); if(window.saveLocalAndRemote) window.saveLocalAndRemote(todayKey, JSON.stringify(savedData)); renderPrayerTracker(); }
        function renderFastingTracker() { const container = document.getElementById('fasting-tracker-list'); const todayKey = `fasting_${new Date().toLocaleDateString()}`; const savedData = JSON.parse(localStorage.getItem(todayKey)) || {}; let html = ''; fastingTasks.forEach(task => { const isCompleted = savedData[task.key] || false; const statusClass = isCompleted ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-100'; const iconHtml = isCompleted ? `<div class="w-5 h-5 rounded border bg-white border-transparent flex items-center justify-center"><i class="fas fa-check text-emerald-600 text-xs"></i></div>` : `<div class="w-5 h-5 rounded border border-gray-300 flex items-center justify-center bg-white"></div>`; const textClass = isCompleted ? 'text-gray-700 font-bold' : 'text-gray-600'; html += `<div onclick="toggleFasting('${task.key}')" class="cursor-pointer border rounded-lg p-3 flex items-center gap-3 select-none transition ${statusClass}">${iconHtml}<span class="text-sm ${textClass}">${task.label}</span></div>`; }); if(container) container.innerHTML = html; }
        function toggleFasting(key) { const todayKey = `fasting_${new Date().toLocaleDateString()}`; const savedData = JSON.parse(localStorage.getItem(todayKey)) || {}; const wasKaza = savedData['kaza']; if (savedData[key]) { delete savedData[key]; } else { for (let k in savedData) delete savedData[k]; savedData[key] = true; } const isKaza = savedData['kaza']; if (!wasKaza && isKaza) { updateFastingDebt(-1, true); } else if (wasKaza && !isKaza) { updateFastingDebt(1, true); } localStorage.setItem(todayKey, JSON.stringify(savedData)); if(window.saveLocalAndRemote) window.saveLocalAndRemote(todayKey, JSON.stringify(savedData)); renderFastingTracker(); }
        function renderSadakaTracker() { const container = document.getElementById('sadaka-tracker-container'); if (!container) return; const todayKey = `sadaka_${new Date().toLocaleDateString()}`; const savedData = JSON.parse(localStorage.getItem(todayKey)) || { completed: false, amount: '' }; const isCompleted = savedData.completed; const statusClass = isCompleted ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-100'; const iconHtml = isCompleted ? `<div class="w-5 h-5 rounded border bg-white border-transparent flex items-center justify-center shrink-0"><i class="fas fa-check text-emerald-600 text-xs"></i></div>` : `<div class="w-5 h-5 rounded border border-gray-300 flex items-center justify-center bg-white shrink-0"></div>`; const textClass = isCompleted ? 'text-gray-700 font-bold' : 'text-gray-600'; const html = `<div class="border rounded-lg p-3 flex items-center gap-3 transition ${statusClass}"><div onclick="toggleSadaka()" class="flex items-center gap-3 flex-1 cursor-pointer select-none">${iconHtml}<span class="text-sm ${textClass}">Sadaka hayrı yaptım</span></div><input type="number" id="sadaka-amount-input" value="${savedData.amount}" oninput="saveSadakaAmount(this.value)" placeholder="₺ Tutar" class="w-20 text-right text-sm p-1.5 border rounded-lg bg-white/80 focus:bg-white focus:ring-2 focus:ring-emerald-500 outline-none placeholder-gray-400 text-gray-700 font-medium transition-all shadow-sm"></div>`; container.innerHTML = html; }
        function toggleSadaka() { const todayKey = `sadaka_${new Date().toLocaleDateString()}`; const savedData = JSON.parse(localStorage.getItem(todayKey)) || { completed: false, amount: '' }; const inputEl = document.getElementById('sadaka-amount-input'); if(inputEl) savedData.amount = inputEl.value; savedData.completed = !savedData.completed; localStorage.setItem(todayKey, JSON.stringify(savedData)); if(window.saveLocalAndRemote) window.saveLocalAndRemote(todayKey, JSON.stringify(savedData)); renderSadakaTracker(); }
        function saveSadakaAmount(val) { const todayKey = `sadaka_${new Date().toLocaleDateString()}`; const savedData = JSON.parse(localStorage.getItem(todayKey)) || { completed: false, amount: '' }; savedData.amount = val; localStorage.setItem(todayKey, JSON.stringify(savedData)); if(window.saveLocalAndRemote) window.saveLocalAndRemote(todayKey, JSON.stringify(savedData)); }
        function renderReligiousStudyTracker() { const container = document.getElementById('religious-study-tracker-container'); if (!container) return; const now = new Date(); const weekKey = `religious_study_${getWeekKey(now)}`; const isCompleted = localStorage.getItem(weekKey) === 'true'; const statusClass = isCompleted ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-100'; const iconHtml = isCompleted ? `<div class="w-5 h-5 rounded border bg-white border-transparent flex items-center justify-center shrink-0"><i class="fas fa-check text-emerald-600 text-xs"></i></div>` : `<div class="w-5 h-5 rounded border border-gray-300 flex items-center justify-center bg-white shrink-0"></div>`; const textClass = isCompleted ? 'text-gray-700 font-bold' : 'text-gray-600'; const html = `<div onclick="toggleReligiousStudy()" class="cursor-pointer border rounded-lg p-3 flex items-center gap-3 select-none transition ${statusClass}">${iconHtml}<span class="text-sm ${textClass}">Okuma yaptım</span></div>`; container.innerHTML = html; }
        function toggleReligiousStudy() { const now = new Date(); const weekKey = `religious_study_${getWeekKey(now)}`; const currentState = localStorage.getItem(weekKey) === 'true'; if (currentState) { localStorage.removeItem(weekKey); } else { localStorage.setItem(weekKey, 'true'); } if(window.saveLocalAndRemote) window.saveLocalAndRemote(weekKey, localStorage.getItem(weekKey)); renderReligiousStudyTracker(); }
        function getWeekKey(date) { const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate())); const dayNum = d.getUTCDay() || 7; d.setUTCDate(d.getUTCDate() + 4 - dayNum); const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7); return `${d.getUTCFullYear()}_W${weekNo}`; }
        function getDailyCounts() { const todayKey = `daily_dhikr_counts_${new Date().toLocaleDateString()}`; return JSON.parse(localStorage.getItem(todayKey)) || {}; }
        function saveDailyCount(id, val) { const todayKey = `daily_dhikr_counts_${new Date().toLocaleDateString()}`; const counts = getDailyCounts(); counts[id] = val; localStorage.setItem(todayKey, JSON.stringify(counts)); if(window.saveLocalAndRemote) window.saveLocalAndRemote(todayKey, JSON.stringify(counts)); }
        function renderDailyDhikrs() { const container = document.getElementById('daily-dhikr-list'); const counts = getDailyCounts(); let html = ''; dailyDhikrs.forEach((dhikr) => { const count = counts[dhikr.id] || 0; const isTargetReached = count >= 33; const statusClass = isTargetReached ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-gray-100 hover:bg-gray-50'; const iconHtml = isTargetReached ? `<div class="w-5 h-5 rounded border bg-white border-transparent flex items-center justify-center"><i class="fas fa-check text-emerald-600 text-xs"></i></div>` : `<div class="w-5 h-5 rounded border border-gray-300 flex items-center justify-center"></div>`; const textClass = isTargetReached ? 'text-gray-600' : 'text-gray-800'; const countColor = isTargetReached ? 'text-emerald-600' : 'text-gray-400'; const completedLabel = isTargetReached ? `<span class="text-[10px] font-bold text-emerald-600 block text-right mt-0.5">Tamamlandı</span>` : ''; html += `<div class="border rounded-lg p-3 flex items-start gap-3 transition select-none ${statusClass}" onclick="startDhikrSession('${dhikr.id}')"><div class="mt-0.5 cursor-pointer" onclick="toggleManualCompletion(event, '${dhikr.id}')">${iconHtml}</div><div class="flex-1 cursor-pointer"><div class="flex justify-between items-start"><p class="text-xs font-medium ${textClass} leading-relaxed flex-1">${dhikr.text}</p><div class="flex flex-col items-end ml-2 shrink-0"><span class="text-xs font-bold ${countColor}">${count}/33</span>${completedLabel}</div></div></div></div>`; }); container.innerHTML = html; }
        function toggleManualCompletion(event, id) { event.stopPropagation(); const counts = getDailyCounts(); let current = counts[id] || 0; if (current >= 33) { current = 0; } else { current = 33; } saveDailyCount(id, current); renderDailyDhikrs(); }
        function renderTevhidHatmi() { const count = parseInt(localStorage.getItem('tevhid_hatmi_total')) || 0; document.getElementById('tevhid-display-count').textContent = `${count}/70000`; const pct = Math.min(100, (count / 70000) * 100); document.getElementById('tevhid-progress').style.width = `${pct}%`; }
        function addManualTevhid() { const input = document.getElementById('manual-tevhid-input'); const val = parseInt(input.value); if (!val || val <= 0) return; let count = parseInt(localStorage.getItem('tevhid_hatmi_total')) || 0; count += val; localStorage.setItem('tevhid_hatmi_total', count); if(window.saveLocalAndRemote) window.saveLocalAndRemote('tevhid_hatmi_total', count); input.value = ''; renderTevhidHatmi(); }
        function startTevhidSession() { activeDhikrId = 'tevhid_hatmi'; currentDhikr = "Lâ ilâhe illallâh"; dhikrCount = parseInt(localStorage.getItem('tevhid_hatmi_total')) || 0; updateDhikrUI(); switchTab('zikir'); }
        function startDhikrSession(id) { const dhikrObj = dailyDhikrs.find(d => d.id === id); if(dhikrObj) { activeDhikrId = id; currentDhikr = dhikrObj.text; const counts = getDailyCounts(); dhikrCount = counts[id] || 0; updateDhikrUI(); switchTab('zikir'); } }
        function openFreeZikirMode() { activeDhikrId = null; currentDhikr = null; dhikrCount = parseInt(localStorage.getItem('freeDhikrCount')) || 0; updateDhikrUI(); switchTab('zikir'); }
        function loadDebts() { const debts = JSON.parse(localStorage.getItem('prayerDebts')) || {}; const container = document.getElementById('debt-list'); let html = ''; prayers.forEach(p => { if (p.key === 'Tahajjud') return; const count = debts[p.key] || 0; html += `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100"><span class="font-medium text-gray-700 w-20">${p.label}</span><div class="flex items-center gap-3"><button onclick="updateDebt('${p.key}', -1)" class="debt-btn bg-emerald-100 text-emerald-700 hover:bg-emerald-200 disabled:opacity-50" ${count<=0?'disabled':''}><i class="fas fa-check"></i></button><span class="text-lg font-bold w-12 text-center font-mono text-gray-800">${count}</span><button onclick="updateDebt('${p.key}', 1)" class="debt-btn bg-red-100 text-red-700 hover:bg-red-200"><i class="fas fa-plus"></i></button></div></div>`; }); container.innerHTML = html; const fastingDebt = parseInt(localStorage.getItem('fastingDebt')) || 0; const fDisplay = document.getElementById('fasting-debt-display'); if(fDisplay) fDisplay.textContent = fastingDebt; }
        function updateDebt(key, delta) { const debts = JSON.parse(localStorage.getItem('prayerDebts')) || {}; let current = debts[key] || 0; current += delta; if(current < 0) current = 0; debts[key] = current; localStorage.setItem('prayerDebts', JSON.stringify(debts)); if(window.saveLocalAndRemote) window.saveLocalAndRemote('prayerDebts', JSON.stringify(debts)); loadDebts(); }
        function updateFastingDebt(delta, suppressAlert = false) { let current = parseInt(localStorage.getItem('fastingDebt')) || 0; current += delta; if(current < 0) current = 0; localStorage.setItem('fastingDebt', current); if(window.saveLocalAndRemote) window.saveLocalAndRemote('fastingDebt', current); loadDebts(); }
        function checkAndMigrateDebts() { const lastDate = localStorage.getItem('lastSessionDate'); const today = new Date().toLocaleDateString(); if (lastDate && lastDate !== today) { const lastDayKey = `prayers_${lastDate}`; const lastDayData = JSON.parse(localStorage.getItem(lastDayKey)) || {}; const debts = JSON.parse(localStorage.getItem('prayerDebts')) || {}; let addedCount = 0; prayers.forEach(p => { if (p.key === 'Tahajjud') return; if (!lastDayData[p.key]) { debts[p.key] = (debts[p.key] || 0) + 1; addedCount++; } }); if(addedCount > 0) { localStorage.setItem('prayerDebts', JSON.stringify(debts)); if(window.saveLocalAndRemote) window.saveLocalAndRemote('prayerDebts', JSON.stringify(debts)); alert(`${lastDate} tarihli ${addedCount} adet kılınmayan namaz borçlarınıza eklendi.`); loadDebts(); } } localStorage.setItem('lastSessionDate', today); }
        function populateCitySelect() { const select = document.getElementById('city-select'); select.innerHTML = '<option value="">Seçiniz</option>'; Object.keys(TURKEY_CITIES).sort((a,b) => a.localeCompare(b,'tr')).forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.textContent = c; select.appendChild(opt); }); }
        function handleCityChange() { const city = document.getElementById('city-select').value; const dist = document.getElementById('district-select'); dist.innerHTML = '<option value="">İlçe Seçiniz</option>'; if(!city) { dist.disabled = true; return; } TURKEY_CITIES[city].sort((a,b) => a.localeCompare(b,'tr')).forEach(d => { const opt = document.createElement('option'); opt.value = d; opt.textContent = d; dist.appendChild(opt); }); dist.disabled = false; }
        function openLocationModal() { openModal('locationModal'); }
        function saveLocation() { const city = document.getElementById('city-select').value; const district = document.getElementById('district-select').value; if(!city || !district) return; locationData = { city, district }; localStorage.setItem('userLocation', JSON.stringify(locationData)); if(window.saveLocalAndRemote) window.saveLocalAndRemote('userLocation', JSON.stringify(locationData)); document.getElementById('location-display').textContent = `${district}, ${city}`; fetchPrayerTimes(city, district); closeModal('locationModal'); }
        async function fetchPrayerTimes(city, district) { const date = new Date(); const dateStr = `${date.getDate()}-${date.getMonth()+1}-${date.getFullYear()}`; try { const response = await fetch(`https://api.aladhan.com/v1/timingsByAddress/${dateStr}?address=${district},${city},Turkey&method=13`); const data = await response.json(); if(data.code === 200) { prayerTimes = data.data.timings; renderPrayerTimes(); startCountdown(); } } catch(e) { console.error(e); } }
        function renderPrayerTimes() { if(!prayerTimes) return; const list = document.getElementById('prayer-times-list'); const types = [{k:'Fajr',l:'İmsak'},{k:'Sunrise',l:'Güneş'},{k:'Dhuhr',l:'Öğle'},{k:'Asr',l:'İkindi'},{k:'Maghrib',l:'Akşam'},{k:'Isha',l:'Yatsı'}]; const now = new Date(); const currentMin = now.getHours()*60 + now.getMinutes(); let html = ''; let activeIdx = -1; const mins = types.map(t => { const [h,m] = prayerTimes[t.k].split(':'); return parseInt(h)*60 + parseInt(m); }); for(let i=0; i<mins.length; i++) if(currentMin >= mins[i]) activeIdx = i; types.forEach((t, i) => { html += `<div class="prayer-time-item ${i===activeIdx?'active':''}"><span class="block opacity-70 mb-1">${t.l}</span><span>${prayerTimes[t.k]}</span></div>`; }); list.innerHTML = html; }
        function startCountdown() { if(!prayerTimes) return; const now = new Date(); const keys = ['Fajr','Sunrise','Dhuhr','Asr','Maghrib','Isha']; const labels = ['İmsak','Güneş','Öğle','İkindi','Akşam','Yatsı']; let target = null; let label = ""; for(let i=0; i<keys.length; i++) { const [h,m] = prayerTimes[keys[i]].split(':'); const d = new Date(); d.setHours(h, m, 0, 0); if(d > now) { target = d; label = labels[i]; break; } } if(!target) { label = "İmsak (Yarın)"; const [h,m] = prayerTimes['Fajr'].split(':'); target = new Date(); target.setDate(target.getDate()+1); target.setHours(h, m, 0, 0); } 
        // Update both expanded and collapsed elements
        document.getElementById('next-prayer-name').textContent = label; 
        document.getElementById('collapsed-prayer-name').textContent = label;
        
        if(window.pInterval) clearInterval(window.pInterval); window.pInterval = setInterval(() => { const diff = target - new Date(); if(diff <= 0) { clearInterval(window.pInterval); fetchPrayerTimes(locationData.city, locationData.district); return; } const h = Math.floor((diff/3600000)%24), m = Math.floor((diff/60000)%60), s = Math.floor((diff/1000)%60); 
        const timeStr = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        document.getElementById('countdown-timer').textContent = timeStr; 
        document.getElementById('collapsed-countdown').textContent = `Kalan: ${timeStr}`;
        
        // Update the static time in collapsed view (e.g. 15:32)
        const targetH = target.getHours().toString().padStart(2,'0');
        const targetM = target.getMinutes().toString().padStart(2,'0');
        document.getElementById('collapsed-prayer-time').textContent = `${targetH}:${targetM}`;
        
        }, 1000); }
        function toggleReadingMode() { document.body.classList.toggle('reading-mode'); }
        async function openTranslation() { const overlay = document.getElementById('translation-overlay'); const content = document.getElementById('translation-content'); overlay.classList.remove('hidden'); if(translationDataCache) return; content.innerHTML = '<div class="text-center mt-10"><i class="fas fa-spinner fa-spin text-emerald-600"></i> Yükleniyor...</div>'; let apiPage = currentQuranPage + 1; if(apiPage > 604) apiPage = 604; try { const response = await fetch(`https://api.alquran.cloud/v1/page/${apiPage}/tr.diyanet`); const data = await response.json(); if(data.code === 200) { translationDataCache = data.data.ayahs; let html = ""; data.data.ayahs.forEach(ayah => { html += `<div class="mb-4 pb-2 border-b border-gray-100 last:border-0"><span class="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full mb-1 inline-block">${ayah.surah.englishName} : ${ayah.numberInSurah}</span><p>${ayah.text}</p></div>`; }); content.innerHTML = html; } } catch(e) { content.innerHTML = "Meal yüklenemedi."; } }
        function closeTranslation() { document.getElementById('translation-overlay').classList.add('hidden'); }
        function updateDate() { const d = new Date(); document.getElementById('current-date').textContent = d.toLocaleDateString('tr-TR', {weekday:'long', year:'numeric', month:'long', day:'numeric'}); const ramadan = new Date(d.getFullYear(), 2, 1); if(d > ramadan) ramadan.setFullYear(d.getFullYear()+1); document.getElementById('days-left').textContent = Math.ceil((ramadan-d)/86400000); }
        function loadDhikrState() {}
        function updateDhikrUI() { const counterEl = document.getElementById('counter-display'); const nameEl = document.getElementById('current-dhikr-name'); const barContainer = document.getElementById('dhikr-info-bar'); const freeModeCounter = document.getElementById('free-mode-counter'); const targetDisplay = document.getElementById('target-display'); if (activeDhikrId && currentDhikr) { barContainer.classList.remove('hidden'); freeModeCounter.classList.add('hidden'); counterEl.textContent = dhikrCount; nameEl.textContent = currentDhikr; let target = 33; if (activeDhikrId === 'tevhid_hatmi') target = 70000; targetDisplay.textContent = `/${target}`; if (dhikrCount >= target) counterEl.classList.add('goal-reached'); else counterEl.classList.remove('goal-reached'); } else { barContainer.classList.add('hidden'); freeModeCounter.classList.remove('hidden'); document.getElementById('free-counter-display').textContent = dhikrCount; } }
        function initZikirGestures() { const touchArea = document.getElementById('touch-area'); const activeBead = document.getElementById('active-bead'); let startY = 0; let isDragging = false; const handleStart = (y) => { isDragging = true; startY = y; activeBead.style.transition = 'none'; }; const handleMove = (y) => { if (!isDragging) return; const delta = y - startY; if (delta > 0) { let newTop = 110 + Math.min(delta, 220); activeBead.style.top = `${newTop}px`; } }; const handleEnd = (y) => { if(!isDragging) return; isDragging = false; const delta = y - startY; activeBead.style.transition = 'top 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)'; if (delta > 80) { activeBead.style.top = `280px`; playBeadSound(); dhikrCount++; if (activeDhikrId === 'tevhid_hatmi') { localStorage.setItem('tevhid_hatmi_total', dhikrCount); if(window.saveLocalAndRemote) window.saveLocalAndRemote('tevhid_hatmi_total', dhikrCount); renderTevhidHatmi(); } else if (activeDhikrId) { saveDailyCount(activeDhikrId, dhikrCount); renderDailyDhikrs(); } else { localStorage.setItem('freeDhikrCount', dhikrCount); if(window.saveLocalAndRemote) window.saveLocalAndRemote('freeDhikrCount', dhikrCount); } updateDhikrUI(); if (navigator.vibrate) navigator.vibrate(25); setTimeout(() => { activeBead.style.transition = 'none'; activeBead.style.opacity = '0'; activeBead.style.top = `110px`; setTimeout(() => { activeBead.style.transition = 'opacity 0.2s ease-in'; activeBead.style.opacity = '1'; }, 50); }, 200); } else { activeBead.style.top = `110px`; } }; touchArea.addEventListener('touchstart', e => handleStart(e.touches[0].clientY), {passive:false}); touchArea.addEventListener('touchmove', e => { if(isDragging) { e.preventDefault(); handleMove(e.touches[0].clientY); } }, {passive:false}); touchArea.addEventListener('touchend', e => handleEnd(e.changedTouches[0].clientY)); touchArea.addEventListener('mousedown', e => { e.preventDefault(); handleStart(e.clientY); }); window.addEventListener('mousemove', e => handleMove(e.clientY)); window.addEventListener('mouseup', e => handleEnd(e.clientY)); }
        function resetDhikr() { dhikrCount = 0; localStorage.setItem('dhikrCount', 0); updateDhikrUI(); }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function loadHatimList() { const stored = localStorage.getItem('hatimList'); if (stored) { hatimList = JSON.parse(stored); } else { hatimList = [{ id: Date.now(), name: "Hatmim", page: 0, date: new Date().toLocaleDateString() }]; saveHatimList(); } renderHatimList(); }
        function saveHatimList() { localStorage.setItem('hatimList', JSON.stringify(hatimList)); if(window.saveLocalAndRemote) window.saveLocalAndRemote('hatimList', JSON.stringify(hatimList)); renderHatimList(); }
        function createNewHatim() { const name = document.getElementById('new-hatim-name').value.trim(); if(!name) return; hatimList.push({ id: Date.now(), name: name, page: currentQuranPage, date: new Date().toLocaleDateString() }); saveHatimList(); setActiveHatim(hatimList[hatimList.length-1].id); document.getElementById('new-hatim-name').value = ''; }
        function setActiveHatim(id) { activeHatimId = id; const hatim = hatimList.find(h => h.id === id); if(hatim) { document.getElementById('active-hatim-display').classList.remove('hidden-force'); document.getElementById('active-hatim-display').classList.add('flex-force'); document.getElementById('active-hatim-name').textContent = hatim.name; fetchPage(hatim.page); closeModal('hatimListModal'); } }
        function saveHatimLocation() { if(!activeHatimId) { alert("Lütfen önce bir Hatim seçin."); openModal('hatimListModal'); return; } const index = hatimList.findIndex(h => h.id === activeHatimId); if(index !== -1) { const oldPage = hatimList[index].page; const newPage = currentQuranPage; if (newPage > oldPage) { const pagesRead = newPage - oldPage; updateDailyQuranPage(pagesRead); } hatimList[index].page = currentQuranPage; hatimList[index].date = new Date().toLocaleDateString(); saveHatimList(); alert("Kaydedildi."); } }
        function deleteHatim(id) { if(confirm('Silinsin mi?')) { hatimList = hatimList.filter(h => h.id !== id); if(activeHatimId === id) { activeHatimId = null; document.getElementById('active-hatim-display').classList.add('hidden-force'); } saveHatimList(); } }
        function renderHatimList() { const container = document.getElementById('hatim-list-container'); container.innerHTML = ''; hatimList.forEach(hatim => { container.innerHTML += `<div class="flex items-center justify-between p-3 border-b"><div onclick="setActiveHatim(${hatim.id})" class="flex-1 cursor-pointer font-bold text-sm">${hatim.name} <span class="font-normal text-xs text-gray-500">(${hatim.page}. Sayfa)</span></div><button onclick="deleteHatim(${hatim.id})" class="text-red-500"><i class="fas fa-trash"></i></button></div>`; }); }
        function switchTab(id) { document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); document.getElementById(`tab-${id}`).classList.add('active'); 
        
        // 2. Header Durumunu Ayarla
        const body = document.body;
        if (id === 'home') {
            // Günlük sekmesine dönüldüğünde scroll pozisyonuna bak
            const tabHome = document.getElementById('tab-home');
            if (tabHome.scrollTop > 30) {
                body.classList.add('header-shrunk');
            } else {
                body.classList.remove('header-shrunk');
            }
        } else {
            // Diğer sekmelerde her zaman kapalı (shrunk) olsun
            body.classList.add('header-shrunk');
        }

        // 3. Nav Buton Renklerini Güncelle (Yeni Temaya Uygun: Sarı / Beyaz Opak)
        document.querySelectorAll('.nav-btn').forEach(btn => {
            // Aktif sınıfını ve rengini temizle
            btn.classList.remove('text-yellow-300');
            // Pasif rengi ekle
            btn.classList.add('text-white/60');
            btn.classList.add('hover:text-white');
        });

        // Tıklanan butonu aktif yap
        let idx = 0;
        if (id === 'quran') idx = 1;
        else if (id === 'zikir') idx = 2;
        else if (id === 'borclar') idx = 3;
        
        const activeBtn = document.querySelectorAll('.nav-btn')[idx];
        activeBtn.classList.remove('text-white/60');
        activeBtn.classList.remove('hover:text-white');
        activeBtn.classList.add('text-yellow-300');
     }
        function loadTasks() { const container = document.getElementById('task-list'); const key = `tasks_${new Date().toLocaleDateString()}`; const data = JSON.parse(localStorage.getItem(key)) || {}; container.innerHTML = ''; tasks.forEach(t => { const checked = data[t.id] ? 'checked' : ''; container.innerHTML += `<label class="flex items-center p-3 rounded-lg border border-gray-100 hover:bg-gray-50 transition cursor-pointer select-none"><input type="checkbox" onchange="saveTask(${t.id})" class="w-5 h-5 text-emerald-600 rounded focus:ring-emerald-500 border-gray-300" ${checked}><div class="ml-3 flex-1 text-sm font-medium text-gray-700">${t.text}</div><i class="fas ${t.icon} text-emerald-200"></i></label>`; }); }
        function saveTask(id) { const key = `tasks_${new Date().toLocaleDateString()}`; const data = JSON.parse(localStorage.getItem(key)) || {}; if(data[id]) delete data[id]; else data[id] = true; localStorage.setItem(key, JSON.stringify(data)); }
        function resetTasks() { localStorage.removeItem(`tasks_${new Date().toLocaleDateString()}`); loadTasks(); }
        function fetchPage(n) { if(n<0) n=0; if(n>totalPages) n=totalPages; currentQuranPage = n; document.getElementById('page-num').textContent = n; document.getElementById('trans-page-num').textContent = n; updateHeaderInfo(n); const src = `https://surahquran.com/img/pages-quran/mushaf/s${n}.png`; document.getElementById('quran-page-image').src = src; const rDisp = document.getElementById('reading-display'); if(rDisp) { rDisp.innerHTML = `<img src="${src}" class="w-full h-auto shadow-sm block">`; if(!isAutoScrolling) rDisp.scrollTop = 0; } }
        function changePage(d) { fetchPage(currentQuranPage + d); }
        function updateHeaderInfo(p) { let jIdx = 30; for(let i=0; i<juzList.length; i++) if(p < juzList[i].page) { jIdx = i; break; } if(jIdx===0) jIdx=1; let sName = "Fâtiha"; for(let i=0; i<surahList.length; i++) if(surahList[i].page > p) { sName = surahList[i-1]?surahList[i-1].name:"Fâtiha"; break; } if(p===604) sName="Nâs"; document.getElementById('current-juz-info').textContent = `${jIdx}. Cüz`; document.getElementById('current-surah-info').textContent = sName; if(document.getElementById('reading-page-info')) { document.getElementById('reading-page-info').textContent = p; document.getElementById('reading-surah-info').textContent = sName; document.getElementById('reading-juz-info').textContent = `${jIdx}. Cüz`; } }
        function handleSearchInput(value) { const suggestionsBox = document.getElementById('search-suggestions'); const query = normalizeTr(value.trim()); suggestionsBox.innerHTML = ''; if (query.length < 2 && !Number(query)) { suggestionsBox.classList.add('hidden'); return; } let matches = []; surahList.forEach(surah => { if (normalizeTr(surah.name).includes(query)) matches.push({ type: 'Sure', label: surah.name + ' Suresi', page: surah.page }); }); if (query.includes('cuz')) { let num = parseInt(query.replace(/\D/g,'')); if(num >= 1 && num <= 30) matches.push({ type: 'Cüz', label: num + '. Cüz', page: juzList.find(j => j.id === num).page }); } if (!isNaN(query)) { let page = parseInt(query); if (page >= 0 && page <= 604) matches.push({ type: 'Sayfa', label: 'Sayfa ' + page, page: page }); if (page >= 1 && page <= 30) matches.push({ type: 'Cüz', label: page + '. Cüz', page: juzList.find(j => j.id === page).page }); } if (matches.length > 0) { suggestionsBox.classList.remove('hidden'); matches.slice(0, 5).forEach(match => { const div = document.createElement('div'); div.className = 'suggestion-item px-4 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-50'; div.innerHTML = `<span class="font-medium">${match.label}</span> <span class="text-xs text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full ml-2">${match.type}</span>`; div.onclick = () => { fetchPage(match.page); suggestionsBox.classList.add('hidden'); document.getElementById('unified-search').value = ''; }; suggestionsBox.appendChild(div); }); } else { suggestionsBox.classList.add('hidden'); } }
        document.addEventListener('click', function(e) { if (!document.getElementById('unified-search').contains(e.target)) document.getElementById('search-suggestions').classList.add('hidden'); });
        function toggleAutoScroll() { const defaultTools = document.getElementById('default-tools'); const scrollTools = document.getElementById('scroll-tools'); const landPlay = document.getElementById('reading-play-btn'); if(isAutoScrolling) { isAutoScrolling = false; if(animationFrameId) cancelAnimationFrame(animationFrameId); scrollTools.classList.add('hidden-force'); scrollTools.classList.remove('flex-force'); defaultTools.classList.remove('hidden-force'); defaultTools.classList.add('flex-force'); if(landPlay) landPlay.innerHTML = '<i class="fas fa-play text-lg"></i>'; } else { isAutoScrolling = true; defaultTools.classList.add('hidden-force'); defaultTools.classList.remove('flex-force'); scrollTools.classList.remove('hidden-force'); scrollTools.classList.add('flex-force'); if(landPlay) landPlay.innerHTML = '<i class="fas fa-pause text-lg"></i>'; const display = document.body.classList.contains('reading-mode') ? document.getElementById('reading-display') : document.getElementById('quran-display'); scrollFloat = display.scrollTop; lastFrameTime = performance.now(); animateScroll(); } }
        function adjustScrollSpeed(delta) { let newSpeed = scrollSpeed + delta; if(newSpeed < 1) newSpeed = 1; if(newSpeed > 100) newSpeed = 100; scrollSpeed = newSpeed; document.getElementById('speed-display').textContent = scrollSpeed; if(document.getElementById('speed-display-reading')) document.getElementById('speed-display-reading').textContent = scrollSpeed; }
        function animateScroll() { if(!isAutoScrolling) return; const display = document.body.classList.contains('reading-mode') ? document.getElementById('reading-display') : document.getElementById('quran-display'); const now = performance.now(); const dt = now - lastFrameTime; lastFrameTime = now; const pixelsPerSecond = scrollSpeed * 1.5; const moveAmount = (pixelsPerSecond * dt) / 1000; scrollFloat += moveAmount; display.scrollTop = scrollFloat; if(display.scrollTop >= display.scrollHeight - display.clientHeight) { toggleAutoScroll(); return; } animationFrameId = requestAnimationFrame(animateScroll); }
    </script>
</body>
</html>
